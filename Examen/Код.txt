namespace Model
{
    public class AdminsModel : HumansModel
    {
        public AdminsModel(int id, string login, string password, string? name, string? surname, string? patronymic, string mail, string? phone_number, DateTime? registration_date, int images_id)
            : base(id, login, password, name, surname, patronymic, mail, phone_number, registration_date, images_id) { }
        public AdminsModel(string login, string password, string? name, string? surname, string? patronymic, string mail, string? phone_number, int images_id)
            : base(login, password, name, surname, patronymic, mail, phone_number, images_id) { }
        public AdminsModel(string login, string password, string? name, string? surname, string? patronymic, string mail, string? phone_number)
            : base(login, password, name, surname, patronymic, mail, phone_number) { }
        public AdminsModel(string login, string password, string mail) 
            : base(login, password, mail) { }
        public AdminsModel(string login, string password)
            : base(login, password) { }
    }
}

namespace Model
{
    abstract public class HumansModel
    {
        public HumansModel(int id, string login, string password, string? name, string? surname, string? patronymic, string mail, string? phoneNumber, DateTime? registration_date, int images_id)
        {
            Id = id;
            Login = login;
            Password = password;
            Name = name;
            Surname = surname;
            Patronymic = patronymic;
            Mail = mail;
            PhoneNumber = phoneNumber;
            Registration_date = registration_date;
            Images_id = images_id;
        }
        public HumansModel(string login, string password, string? name, string? surname, string? patronymic, string mail, string? phone_number, int images_id)
        {
            Login = login;
            Password = password;
            Name = name;
            Surname = surname;
            Patronymic = patronymic;
            Mail = mail;
            PhoneNumber = phone_number;
            Images_id = images_id;
        }
        public HumansModel(string login, string password, string? name, string? surname, string? patronymic, string mail, string? phone_number)
        {
            Login = login;
            Password = password;
            Name = name;
            Surname = surname;
            Patronymic = patronymic;
            Mail = mail;
            PhoneNumber = phone_number;
        }
        public HumansModel(string login, string password, string mail)
        {
            Login = login;
            Password = password;
            Mail = mail;
        }
        public HumansModel(string login, string password)
        {
            Login = login;
            Password = password;
            Mail = string.Empty;
        }
        public int Id { get; set; }
        public string Login { get; set; }
        public string Password { get; set; }
        public string? Name { get; set; }
        public string? Surname { get; set; }
        public string? Patronymic { get; set; }
        public string Mail { get; set; }
        public string? PhoneNumber { get; set; }
        public Nullable<System.DateTime> Registration_date { get; set; }
        public int? Images_id { get; set; }
        public virtual ImagesModel? Image { get; set; }
        public override string ToString()
        {
            return $"{Id,5} {Login,15} {Name,15} {Surname,15} {Mail,20} {Convert.ToDateTime(Registration_date),20}";
        }
    }
}

namespace Model
{
    public class ImagesModel
    {
        public int Id { get; set; }
        public required string Name { get; set; }
        public required byte[] ImageData { get; set; }
    }
}

namespace Model
{
    public class UsersModel : HumansModel
    {
        public UsersModel(int id, string login, string password, string? name, string? surname, string? patronymic, string mail, string? phone_number, DateTime? registration_date, int images_id)
            : base(id, login, password, name, surname, patronymic, mail, phone_number, registration_date, images_id) { }
        public UsersModel(string login, string password, string? name, string? surname, string? patronymic, string mail, string? phone_number, int images_id)
            : base(login, password, name, surname, patronymic, mail, phone_number, images_id) { }
        public UsersModel(string login, string password, string? name, string? surname, string? patronymic, string mail, string? phone_number)
            : base(login, password, name, surname, patronymic, mail, phone_number) { }
        public UsersModel(string login, string password, string mail)
            : base(login, password, mail) { }
        public UsersModel(string login, string password)
            : base(login, password) { }
    }
}

{
  "profiles": {
    "http": {
      "commandName": "Project",
      "environmentVariables": {
        "ASPNETCORE_ENVIRONMENT": "Development"
      },
      "dotnetRunMessages": true,
      "applicationUrl": "http://localhost:5000"
    },
    "https": {
      "commandName": "Project",
      "environmentVariables": {
        "ASPNETCORE_ENVIRONMENT": "Development"
      },
      "dotnetRunMessages": true,
      "applicationUrl": "https://localhost:5001;http://localhost:5000"
    },
    "Container (Dockerfile)": {
      "commandName": "Docker",
      "launchUrl": "{Scheme}://{ServiceHost}:{ServicePort}",
      "environmentVariables": {
        "ASPNETCORE_HTTPS_PORTS": "8081",
        "ASPNETCORE_HTTP_PORTS": "8080"
      },
      "publishAllPorts": true,
      "useSSL": true
    }
  },
  "$schema": "https://json.schemastore.org/launchsettings.json"
}

using DataLayer.Services;
using Microsoft.AspNetCore.Mvc;

[ApiController]
[Route("api/[controller]")]
public class AdminController : ControllerBase
{
    private readonly Service _service;

    public AdminController(Service service)
    {
        _service = service;
    }

    [HttpPost("execute-query")]
    public async Task<IActionResult> ExecuteQuery([FromBody] QueryRequest request)
    {
        try
        {
            var result = await _service.ExecuteSqlQueryAsync(request.SqlQuery);
            return Ok(result);
        }
        catch (Exception ex)
        {
            return BadRequest(ex.Message);
        }
    }
}

public class QueryRequest
{
    public string SqlQuery { get; set; } = string.Empty;
}

#nullable enable
using DataLayer.Services;
using Microsoft.AspNetCore.Mvc;
using Model;
using Server.Dtos;

[ApiController]
[Route("api/[controller]")]
public class AuthController : ControllerBase
{
    private readonly Service _service;

    public AuthController(Service service)
    {
        _service = service;
    }

    [HttpPost("login")]
    public async Task<IActionResult> Login([FromBody] LoginRequest request)
    {
        if (string.IsNullOrWhiteSpace(request.Login) || string.IsNullOrWhiteSpace(request.Password))
        {
            return BadRequest(new { error = "Логин и пароль обязательны" });
        }

        try
        {
            var user = new UsersModel(request.Login, request.Password);
            var admin = new AdminsModel(request.Login, request.Password);

            if (await _service.OnLoginAsync(user))
            {
                var currentHuman = _service.CurrentHuman
                    ?? throw new InvalidOperationException("CurrentHuman is null after successful login");

                return Ok(new LoginResponse
                {
                    Id = currentHuman.Id,
                    Login = currentHuman.Login,
                    Name = currentHuman.Name ?? string.Empty,
                    Surname = currentHuman.Surname ?? string.Empty,
                    Type = "user"
                });
            }
            else if (await _service.OnLoginAsync(admin))
            {
                var currentHuman = _service.CurrentHuman
                    ?? throw new InvalidOperationException("CurrentHuman is null after successful login");

                return Ok(new LoginResponse
                {
                    Id = currentHuman.Id,
                    Login = currentHuman.Login,
                    Name = currentHuman.Name ?? string.Empty,
                    Surname = currentHuman.Surname ?? string.Empty,
                    Type = "admin"
                });
            }

            return Unauthorized(new { error = "Неверный логин или пароль" });
        }
        catch (Exception ex)
        {
            return StatusCode(500, new { error = ex.Message });
        }
    }

    [HttpPost("logout")]
    public IActionResult Logout()
    {
        _service.LogOut();
        return Ok(new { message = "Выход выполнен" });
    }
}

using Microsoft.AspNetCore.Mvc;
using DataLayer.Services;

namespace Server.Controllers
{
    [ApiController]
    [Route("api/[controller]")]
    public class productsController : ControllerBase
    {
        private readonly Service _service;

        public productsController(Service service)
        {
            _service = service;
        }

        // GET api/products/top3
        [HttpGet("top3")]
        public async Task<IActionResult> GetTop3Products()
        {
            try
            {
                var result = await _service.GetTop3ProductsAsync();
                return Ok(result);
            }
            catch (Exception ex)
            {
                return StatusCode(500, new { error = ex.Message });
            }
        }

        // GET api/products/portion
        [HttpGet("portion")]
        public async Task<IActionResult> GetProductsInPortions(
            [FromQuery] int skipRows = 0,
            [FromQuery] int showRows = 10)
        { 
            try
            {
                var result = await _service.GetShowProductsInPortionsAsync(skipRows, showRows);
                return Ok(result);
            }
            catch (Exception ex)
            {
                return StatusCode(500, new { error = ex.Message });
            }
        }
    }
}

using Microsoft.AspNetCore.Mvc;
using DataLayer.Services;
using Server.Dtos;
using Model;

namespace Server.Controllers
{
    [ApiController]
    [Route("api/[controller]")]
    public class UsersController : ControllerBase
    {
        private readonly Service _service;

        public UsersController(Service service)
        {
            _service = service;
        }

        [HttpGet]
        public async Task<IActionResult> GetAllUsers()
        {
            try
            {
                var users = await _service.GetListAllUsersAsync();
                return Ok(users);
            }
            catch (Exception ex)
            {
                return StatusCode(500, $"Ошибка при получении пользователей: {ex.Message}");
            }
        }

        [HttpGet("{id}")]
        public async Task<IActionResult> GetUserById(int id)
        {
            try
            {
                var user = await _service.GetHumanInfoById(id, "user");
                if (user == null)
                    return NotFound($"Пользователь с ID {id} не найден");

                var dto = new UserDto
                {
                    Id = user.Id,
                    Login = user.Login,
                    Name = user.Name ?? string.Empty,
                    Surname = user.Surname ?? string.Empty,
                    Patronymic = user.Patronymic ?? string.Empty,
                    Mail = user.Mail,
                    PhoneNumber = user.PhoneNumber ?? string.Empty,
                    RegistrationDate = user.Registration_date
                };

                return Ok(dto);
            }
            catch (Exception ex)
            {
                return StatusCode(500, $"Ошибка: {ex.Message}");
            }
        }

        [HttpPost("register")]
        public async Task<IActionResult> RegisterUser([FromBody] RegisterUserRequest request)
        {
            if (!ModelState.IsValid)
                return BadRequest(ModelState);

            try
            {
                var user = new UsersModel(
                    request.Login,
                    request.Password,
                    request.Name,
                    request.Surname,
                    request.Patronymic,
                    request.Mail,
                    request.PhoneNumber
                );

                int userId = await _service.AddHumanAsync(user);
                return CreatedAtAction(nameof(GetUserById), new { id = userId }, new { Id = userId, Message = "Пользователь создан" });
            }
            catch (ArgumentException ex)
            {
                return BadRequest(ex.Message);
            }
            catch (Exception ex)
            {
                return StatusCode(500, $"Ошибка регистрации: {ex.Message}");
            }
        }

        [HttpPut("{id}")]
        public async Task<IActionResult> UpdateUser(int id, [FromBody] UpdateUserRequest request)
        {
            if (!ModelState.IsValid)
                return BadRequest(ModelState);

            try
            {
                await _service.Context_Procedures.Procedures.stp_user_updateAsync(
                    id: id,
                    login: request.Login,
                    password: request.Password,
                    name: request.Name,
                    surname: request.Surname,
                    patronymic: request.Patronymic,
                    mail: request.Mail,
                    phone_number: request.PhoneNumber
                );

                return Ok(new { Message = "Данные пользователя обновлены" });
            }
            catch (Exception ex)
            {
                return StatusCode(500, $"Ошибка обновления: {ex.Message}");
            }
        }

        [HttpDelete("{id}")]
        public async Task<IActionResult> DeleteUser(int id)
        {
            try
            {
                await _service.Context_Procedures.Procedures.stp_user_deleteAsync(id);
                return Ok(new { Message = "Пользователь удалён" });
            }
            catch (Exception ex)
            {
                return StatusCode(500, $"Ошибка удаления: {ex.Message}");
            }
        }
    }

    public class RegisterUserRequest
    {
        public string Login { get; set; } = string.Empty;
        public string Password { get; set; } = string.Empty;
        public string Name { get; set; } = string.Empty;
        public string Surname { get; set; } = string.Empty;
        public string? Patronymic { get; set; }
        public string Mail { get; set; } = string.Empty;
        public string? PhoneNumber { get; set; }
    }

    public class UpdateUserRequest
    {
        public string Login { get; set; } = string.Empty;
        public string? Password { get; set; }
        public string Name { get; set; } = string.Empty;
        public string Surname { get; set; } = string.Empty;
        public string? Patronymic { get; set; }
        public string Mail { get; set; } = string.Empty;
        public string? PhoneNumber { get; set; }
    }
}

namespace Server.Dtos
{
    public class LoginRequest
    {
        public string Login { get; set; } = string.Empty;
        public string Password { get; set; } = string.Empty;
    }
}

namespace Server.Dtos
{
    public class LoginResponse
    {
        public int Id { get; set; }
        public string Login { get; set; } = string.Empty;
        public string Name { get; set; } = string.Empty;
        public string Surname { get; set; } = string.Empty;
        public string Type { get; set; } = "user"; // "user" или "admin"
    }
}

namespace Server.Dtos
{
    public class RegisterUserRequest
    {
        public string Login { get; set; } = string.Empty;
        public string Password { get; set; } = string.Empty;
        public string Name { get; set; } = string.Empty;
        public string Surname { get; set; } = string.Empty;
        public string? Patronymic { get; set; }
        public string Mail { get; set; } = string.Empty;
        public string? PhoneNumber { get; set; }
    }
}

namespace Server.Dtos
{
    public class UserDto
    {
        public int Id { get; set; }
        public string Login { get; set; } = string.Empty;
        public string Name { get; set; } = string.Empty;
        public string Surname { get; set; } = string.Empty;
        public string Patronymic { get; set; } = string.Empty;
        public string Mail { get; set; } = string.Empty;
        public string PhoneNumber { get; set; } = string.Empty;
        public DateTime? RegistrationDate { get; set; }
    }
}

{
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft.AspNetCore": "Warning"
    }
  },
  "AllowedHosts": "*",
  "ConnectionStrings": {
    "ModelsConnection": "Server=localhost,1433;Database=Examen_ModelFirst;User ID=sa;Password=YourStrong!Passw0rd;TrustServerCertificate=True;",
    "ProceduresConnection": "Server=localhost,1433;Database=Examen_ModelFirst;User ID=sa;Password=YourStrong!Passw0rd;TrustServerCertificate=True;",
    "ViewsConnection": "Server=localhost,1433;Database=Examen_ModelFirst;User ID=sa;Password=YourStrong!Passw0rd;TrustServerCertificate=True;"
  }
}

# См. статью по ссылке https://aka.ms/customizecontainer, чтобы узнать как настроить контейнер отладки и как Visual Studio использует этот Dockerfile для создания образов для ускорения отладки.

# Этот этап используется при запуске из VS в быстром режиме (по умолчанию для конфигурации отладки)
FROM mcr.microsoft.com/dotnet/aspnet:9.0 AS base
USER $APP_UID
WORKDIR /app
EXPOSE 8080
ENV ASPNETCORE_URLS=http://+:8080
ENV ASPNETCORE_ENVIRONMENT=Docker


# Этот этап используется для сборки проекта службы
FROM mcr.microsoft.com/dotnet/sdk:9.0 AS build
ARG BUILD_CONFIGURATION=Release
WORKDIR /src
COPY ["Examen/Server/Server.csproj", "Examen/Server/"]
RUN dotnet restore "./Examen/Server/Server.csproj"
COPY . .
WORKDIR "/src/Examen/Server"
RUN dotnet build "./Server.csproj" -c $BUILD_CONFIGURATION -o /app/build

# Этот этап используется для публикации проекта службы, который будет скопирован на последний этап
FROM build AS publish
ARG BUILD_CONFIGURATION=Release
RUN dotnet publish "./Server.csproj" -c $BUILD_CONFIGURATION -o /app/publish /p:UseAppHost=false

# Этот этап используется в рабочей среде или при запуске из VS в обычном режиме (по умолчанию, когда конфигурация отладки не используется)
FROM base AS final
WORKDIR /app
COPY --from=publish /app/publish .
COPY ["Examen/Server/appsettings.Docker.json", "/app/appsettings.Docker.json"]
ENTRYPOINT ["dotnet", "Server.dll"]

using DataLayer.Services;
using Microsoft.EntityFrameworkCore;

var builder = WebApplication.CreateBuilder(args);

// Добавляем сервисы в контейнер DI (Регистрация DbContext)
builder.Services.AddDbContext<DataLayer.Models.DataBaseContext>(options =>
    options.UseSqlServer(builder.Configuration.GetConnectionString("ModelsConnection")));

builder.Services.AddDbContext<DataLayer.Procedures.DataBaseContext>(options =>
    options.UseSqlServer(builder.Configuration.GetConnectionString("ProceduresConnection")));

builder.Services.AddDbContext<DataLayer.Views.DataBaseContext>(options =>
    options.UseSqlServer(builder.Configuration.GetConnectionString("ViewsConnection")));

// Регистрируем сервис
builder.Services.AddScoped<Service>();

// Добавляем контроллеры (API)
builder.Services.AddControllers();

// Добавляем Swagger
builder.Services.AddSwaggerGen(c =>
{
    c.SwaggerDoc("v1", new Microsoft.OpenApi.Models.OpenApiInfo
    {
        Title = "Examen API",
        Version = "v1"
    });
});

// CORS - чтобы WPF клиент мог обращаться к серверу
builder.Services.AddCors(options =>
{
    options.AddPolicy("AllowAll", policy =>
    {
        policy.AllowAnyOrigin()  // Разрешает запросы с любого домена (для разработки)
              .AllowAnyMethod()  // Разрешает любые методы (GET, POST, PUT и т.д.)
              .AllowAnyHeader(); // Разрешает любые заголовки
    });
});

var app = builder.Build();

app.UseSwagger();
app.UseSwaggerUI(c =>
{
    c.SwaggerEndpoint("/swagger/v1/swagger.json", "Examen API V1");
});

app.UseHttpsRedirection();
app.UseCors("AllowAll");
app.MapControllers();

app.Run();

@Server_HostAddress = http://localhost:5191

GET {{Server_HostAddress}}/weatherforecast/
Accept: application/json

###

<Project Sdk="Microsoft.NET.Sdk.Web">

  <PropertyGroup>
    <TargetFramework>net9.0</TargetFramework>
    <Nullable>enable</Nullable>
    <ImplicitUsings>enable</ImplicitUsings>
    <UserSecretsId>f0209682-58a7-4ea6-a4f4-fe97698d7a9e</UserSecretsId>
    <DockerDefaultTargetOS>Linux</DockerDefaultTargetOS>
	<DockerfileContext>..\..</DockerfileContext>
  </PropertyGroup>

  <ItemGroup>
    <PackageReference Include="Microsoft.VisualStudio.Azure.Containers.Tools.Targets" Version="1.23.0" />
    <PackageReference Include="Swashbuckle.AspNetCore" Version="9.0.6" />
	<PackageReference Include="Microsoft.AspNetCore.Mvc.NewtonsoftJson" Version="9.0.0" />
  </ItemGroup>

  <ItemGroup>
    <ProjectReference Include="..\DataLayer\DataLayer.csproj" />
    <ProjectReference Include="..\Model\Model.csproj" />
  </ItemGroup>

</Project>

<Project Sdk="Microsoft.NET.Sdk">

  <PropertyGroup>
    <TargetFramework>net9.0</TargetFramework>
    <ImplicitUsings>enable</ImplicitUsings>
    <Nullable>enable</Nullable>
  </PropertyGroup>

</Project>

<Project Sdk="Microsoft.NET.Sdk">

  <PropertyGroup>
    <OutputType>WinExe</OutputType>
    <TargetFramework>net9.0-windows</TargetFramework>
    <Nullable>enable</Nullable>
    <ImplicitUsings>enable</ImplicitUsings>
    <UseWPF>true</UseWPF>
    <RootNamespace>View</RootNamespace>
  </PropertyGroup>

  <ItemGroup>
    <None Remove="Resources\aleksey_n.jpg" />
    <None Remove="Resources\anna_smirnova.jpg" />
    <None Remove="Resources\dmitry_s.jpg" />
    <None Remove="Resources\ekaterina_m.jpg" />
    <None Remove="Resources\ivan_ivanov.jpg" />
    <None Remove="Resources\Johnny_Cash.jpg" />
    <None Remove="Resources\maria_fedorova.jpg" />
    <None Remove="Resources\nina_kuznetsova.jpg" />
    <None Remove="Resources\no_pass.jpg" />
    <None Remove="Resources\olga_ivanova.jpg" />
    <None Remove="Resources\petr_petrov.jpg" />
    <None Remove="Resources\sergey_kozlov.jpg" />
    <None Remove="Resources\Tony_Hawk.jpg" />
    <None Remove="Resources\user_no_pass.jpg" />
    <None Remove="Resources\Книга_SQL_для_начинающих.jpg" />
    <None Remove="Resources\Микроволновая_печь.jpg" />
    <None Remove="Resources\Смартфон_XYZ.jpg" />
    <None Remove="Resources\Теннисная_ракетка.jpg" />
    <None Remove="Resources\Футболка_хлопковая.jpg" />
  </ItemGroup>

  <ItemGroup>
    <Content Include="Resources\aleksey_n.jpg">
      <CopyToOutputDirectory>Always</CopyToOutputDirectory>
    </Content>
    <Content Include="Resources\anna_smirnova.jpg">
      <CopyToOutputDirectory>Always</CopyToOutputDirectory>
    </Content>
    <Content Include="Resources\dmitry_s.jpg">
      <CopyToOutputDirectory>Always</CopyToOutputDirectory>
    </Content>
    <Content Include="Resources\ekaterina_m.jpg">
      <CopyToOutputDirectory>Always</CopyToOutputDirectory>
    </Content>
    <Content Include="Resources\ivan_ivanov.jpg">
      <CopyToOutputDirectory>Always</CopyToOutputDirectory>
    </Content>
    <Content Include="Resources\Johnny_Cash.jpg">
      <CopyToOutputDirectory>Always</CopyToOutputDirectory>
    </Content>
    <Content Include="Resources\maria_fedorova.jpg">
      <CopyToOutputDirectory>Always</CopyToOutputDirectory>
    </Content>
    <Content Include="Resources\nina_kuznetsova.jpg">
      <CopyToOutputDirectory>Always</CopyToOutputDirectory>
    </Content>
    <Content Include="Resources\no_pass.jpg">
      <CopyToOutputDirectory>Always</CopyToOutputDirectory>
    </Content>
    <Content Include="Resources\olga_ivanova.jpg">
      <CopyToOutputDirectory>Always</CopyToOutputDirectory>
    </Content>
    <Content Include="Resources\petr_petrov.jpg">
      <CopyToOutputDirectory>Always</CopyToOutputDirectory>
    </Content>
    <Content Include="Resources\sergey_kozlov.jpg">
      <CopyToOutputDirectory>Always</CopyToOutputDirectory>
    </Content>
    <Content Include="Resources\Tony_Hawk.jpg">
      <CopyToOutputDirectory>Always</CopyToOutputDirectory>
    </Content>
    <Content Include="Resources\user_no_pass.jpg">
      <CopyToOutputDirectory>Always</CopyToOutputDirectory>
    </Content>
    <Content Include="Resources\Книга_SQL_для_начинающих.jpg">
      <CopyToOutputDirectory>Always</CopyToOutputDirectory>
    </Content>
    <Content Include="Resources\Микроволновая_печь.jpg">
      <CopyToOutputDirectory>Always</CopyToOutputDirectory>
    </Content>
    <Content Include="Resources\Смартфон_XYZ.jpg">
      <CopyToOutputDirectory>Always</CopyToOutputDirectory>
    </Content>
    <Content Include="Resources\Теннисная_ракетка.jpg">
      <CopyToOutputDirectory>Always</CopyToOutputDirectory>
    </Content>
    <Content Include="Resources\Футболка_хлопковая.jpg">
      <CopyToOutputDirectory>Always</CopyToOutputDirectory>
    </Content>
  </ItemGroup>

  <ItemGroup>
    <PackageReference Include="EntityFramework" Version="6.5.1" />
    <PackageReference Include="Microsoft.EntityFrameworkCore" Version="9.0.8" />
    <PackageReference Include="Microsoft.EntityFrameworkCore.Design" Version="9.0.8">
      <PrivateAssets>all</PrivateAssets>
      <IncludeAssets>runtime; build; native; contentfiles; analyzers; buildtransitive</IncludeAssets>
    </PackageReference>
    <PackageReference Include="Microsoft.EntityFrameworkCore.SqlServer" Version="9.0.8" />
    <PackageReference Include="Microsoft.Extensions.DependencyInjection" Version="9.0.8" />
  </ItemGroup>

  <ItemGroup>
    <ProjectReference Include="..\ViewModel\ViewModel.csproj" />
  </ItemGroup>

</Project>

<Project Sdk="Microsoft.NET.Sdk">

	<PropertyGroup>
		<TargetFramework>net9.0-windows</TargetFramework>
		<ImplicitUsings>enable</ImplicitUsings>
		<Nullable>disable</Nullable>
		<UseWPF>true</UseWPF>
	</PropertyGroup>

	<ItemGroup>
		<PackageReference Include="Microsoft.Extensions.DependencyInjection" Version="9.0.0" />
	</ItemGroup>

	<ItemGroup>
		<ProjectReference Include="..\..\Examen\Model\Model.csproj" />
	</ItemGroup>

</Project>

services:
  examen-server:
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:8080;https://+:8081

services:
  mssql:
    image: mcr.microsoft.com/mssql/server:2019-latest
    container_name: mssql-server-2019
    environment:
      - ACCEPT_EULA=Y
      - SA_PASSWORD=YourStrong!Passw0rd
      - MSSQL_PID=Developer
    ports:
      - "1433:1433"
    volumes:
      - mssql-data:/var/opt/mssql
      - ./Examen/SQL:/docker-entrypoint-initdb.d
    networks:
      - examen-network
    healthcheck:
      test: ["CMD-SHELL", "/opt/mssql-tools/bin/sqlcmd -S localhost -U sa -P YourStrong!Passw0rd -Q 'SELECT 1' || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  examen-server:
    build:
      context: .
      dockerfile: ./Examen/Server/Dockerfile
    container_name: examen-server
    ports:
      - "5000:8080"  # Внешний порт:Внутренний порт
      - "5001:8081"  # Внешний порт:Внутренний порт
    environment:
      - ASPNETCORE_ENVIRONMENT=Docker
      - ASPNETCORE_URLS=http://+:8080
    networks:
      - examen-network
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      mssql:
        condition: service_healthy

volumes:
  mssql-data:
    driver: local

networks:
  examen-network:
    driver: bridge


#nullable enable
using System.Globalization;
using System.IO;
using System.Windows.Data;
using System.Windows.Media.Imaging;

namespace View.Helpers
{
    public class ByteToImageConverter : IValueConverter
    {
        public object? Convert(object value, Type targetType, object parameter, CultureInfo culture)
        {
            if (value is not byte[] imageData || imageData.Length == 0)
            {
                return null;
            }               

            try
            {
                using var stream = new MemoryStream(imageData);
                var image = new BitmapImage();
                image.BeginInit();
                image.StreamSource = stream;
                image.CacheOption = BitmapCacheOption.OnLoad;
                image.EndInit();
                image.Freeze();
                return image;
            }
            catch
            {
                return null;
            }
        }
        public object ConvertBack(object value, Type targetType, object parameter, CultureInfo culture)
        {
            throw new NotImplementedException();
        }
    }
}

using System.Windows;
using System.Windows.Controls;

namespace View.Helpers
{
    public static class PasswordBoxHelper
    {
        public static readonly DependencyProperty PasswordProperty =
            DependencyProperty.RegisterAttached(
                "Password",
                typeof(string),
                typeof(PasswordBoxHelper),
                new FrameworkPropertyMetadata(
                    string.Empty,
                    FrameworkPropertyMetadataOptions.BindsTwoWayByDefault,
                    OnPasswordChanged)
            );

        public static string GetPassword(DependencyObject dp)
        {
            return (string)dp.GetValue(PasswordProperty);
        }

        public static void SetPassword(DependencyObject dp, string value)
        {
            dp.SetValue(PasswordProperty, value);
        }

        private static bool _isUpdating;

        private static void OnPasswordChanged(DependencyObject d, DependencyPropertyChangedEventArgs e)
        {
            if (d is PasswordBox passwordBox)
            {
                passwordBox.PasswordChanged -= PasswordBox_PasswordChanged;

                if (!_isUpdating && e.NewValue?.ToString() != passwordBox.Password)
                {
                    _isUpdating = true;
                    passwordBox.Password = e.NewValue?.ToString() ?? string.Empty;
                    _isUpdating = false;
                }

                passwordBox.PasswordChanged += PasswordBox_PasswordChanged;
            }
        }

        private static void PasswordBox_PasswordChanged(object sender, RoutedEventArgs e)
        {
            if (sender is PasswordBox passwordBox)
            {
                if (!_isUpdating)
                {
                    _isUpdating = true;
                    SetPassword(passwordBox, passwordBox.Password);
                    _isUpdating = false;
                }
            }
        }
    }
}

<Window
    x:Class="View.ModalWindows.DeleteHumanWindowView"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:local="clr-namespace:View.Helpers"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    Title="Регистрация пользователя"
    Width="400"
    Height="310"
    AllowsTransparency="True"
    Background="Transparent"
    ResizeMode="NoResize"
    ShowInTaskbar="False"
    WindowStartupLocation="CenterOwner"
    WindowStyle="None"
    mc:Ignorable="d">

    <Grid>
        <Border
            Margin="0,24,0,0"
            Background="White"
            CornerRadius="0,0,8,8">

            <StackPanel Margin="20">
                <Grid Height="250">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="100" />
                        <ColumnDefinition Width="*" />
                        <ColumnDefinition Width="200" />
                    </Grid.ColumnDefinitions>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="*" />
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="*" />
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="*" />
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="*" />
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="*" />
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="*" />
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="*" />
                        <RowDefinition Height="Auto" />
                    </Grid.RowDefinitions>

                    <TextBlock
                        Grid.Row="0"
                        Grid.Column="0"
                        Style="{StaticResource UserTextBlockStyle}"
                        Text="Id:" />
                    <TextBox
                        Grid.Row="0"
                        Grid.Column="2"
                        Margin="5,0"
                        Style="{StaticResource UserTextBoxStyle}"
                        Text="{Binding Id, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" />

                    <TextBlock
                        Grid.Row="2"
                        Grid.Column="0"
                        Style="{StaticResource UserTextBlockStyle}"
                        Text="Email:" />
                    <TextBlock
                        Grid.Row="2"
                        Grid.Column="2"
                        Margin="5,0"
                        Style="{StaticResource UserTextBlockStyle}"
                        Text="{Binding Email}" />

                    <TextBlock
                        Grid.Row="4"
                        Grid.Column="0"
                        Style="{StaticResource UserTextBlockStyle}"
                        Text="Login:" />
                    <TextBlock
                        Grid.Row="4"
                        Grid.Column="2"
                        Margin="5,0"
                        Style="{StaticResource UserTextBlockStyle}"
                        Text="{Binding Login}" />

                    <TextBlock
                        Grid.Row="6"
                        Grid.Column="0"
                        Style="{StaticResource UserTextBlockStyle}"
                        Text="Name:" />
                    <TextBlock
                        Grid.Row="6"
                        Grid.Column="2"
                        Margin="5,0"
                        Style="{StaticResource UserTextBlockStyle}"
                        Text="{Binding Name}" />

                    <TextBlock
                        Grid.Row="8"
                        Grid.Column="0"
                        Style="{StaticResource UserTextBlockStyle}"
                        Text="Surname:" />
                    <TextBlock
                        Grid.Row="8"
                        Grid.Column="2"
                        Margin="5,0"
                        Style="{StaticResource UserTextBlockStyle}"
                        Text="{Binding Surname}" />

                    <TextBlock
                        Grid.Row="10"
                        Grid.Column="0"
                        Style="{StaticResource UserTextBlockStyle}"
                        Text="Patronymic:" />
                    <TextBlock
                        Grid.Row="10"
                        Grid.Column="2"
                        Margin="5,0"
                        Style="{StaticResource UserTextBlockStyle}"
                        Text="{Binding Patronymic}" />

                    <TextBlock
                        Grid.Row="12"
                        Grid.Column="0"
                        Style="{StaticResource UserTextBlockStyle}"
                        Text="Phone:" />
                    <TextBlock
                        Grid.Row="12"
                        Grid.Column="2"
                        Margin="5,0"
                        Style="{StaticResource UserTextBlockStyle}"
                        Text="{Binding Phone}" />

                    <Button
                        Grid.Row="14"
                        Grid.Column="0"
                        Command="{Binding SearchHuman}"
                        Content="Search"
                        IsEnabled="{Binding IsEnabledIdInput}"
                        Style="{StaticResource UserButtonStyle}" />
                    <Button
                        Grid.Row="14"
                        Grid.Column="2"
                        Command="{Binding DeleteHuman}"
                        Content="Delete"
                        IsEnabled="{Binding IsEnabledFormDelete}"
                        Style="{StaticResource UserButtonStyle}" />
                </Grid>
            </StackPanel>
        </Border>

        <!--  Кастомная шапка (как в ContainerWindow)  -->
        <Border
            Height="24"
            HorizontalAlignment="Stretch"
            VerticalAlignment="Top"
            Background="#FF333333"
            MouseLeftButtonDown="TitleBar_MouseLeftButtonDown">
            <Grid HorizontalAlignment="Right">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="auto" />
                    <ColumnDefinition Width="auto" />
                    <ColumnDefinition Width="5" />
                </Grid.ColumnDefinitions>

                <!--  КНОПКА СВЕРНУТЬ  -->
                <Button
                    x:Name="MinimizeButton"
                    Grid.Column="0"
                    Width="24"
                    Margin="0,-12,0,0"
                    BorderBrush="Transparent"
                    Click="MinimizeButton_Click"
                    Content="_"
                    FontSize="24"
                    FontWeight="Bold"
                    Style="{StaticResource MinimizeButtonStyle}" />

                <!--  КНОПКА ЗАКРЫТЬ  -->
                <Button
                    x:Name="CloseButton"
                    Grid.Column="1"
                    Width="24"
                    Margin="0,-7,0,0"
                    BorderBrush="Transparent"
                    Click="CloseButton_Click"
                    Content="×"
                    FontSize="24"
                    FontWeight="Bold"
                    Style="{StaticResource CloseButtonStyle}" />
            </Grid>
        </Border>
    </Grid>
</Window>

<Window
    x:Class="View.ModalWindows.RegistrationWindowView"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:local="clr-namespace:View.Helpers"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    Title="Регистрация пользователя"
    Width="400"
    Height="310"
    AllowsTransparency="True"
    Background="Transparent"
    ResizeMode="NoResize"
    ShowInTaskbar="False"
    WindowStartupLocation="CenterOwner"
    WindowStyle="None"
    mc:Ignorable="d">

    <Grid>
        <Border
            Margin="0,24,0,0"
            Background="White"
            CornerRadius="0,0,8,8">

            <StackPanel Margin="20">
                <Grid Height="250">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="100" />
                        <ColumnDefinition Width="*" />
                        <ColumnDefinition Width="200" />
                    </Grid.ColumnDefinitions>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="*" />
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="*" />
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="*" />
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="*" />
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="*" />
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="*" />
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="*" />
                        <RowDefinition Height="Auto" />
                    </Grid.RowDefinitions>

                    <TextBlock
                        Grid.Row="0"
                        Grid.Column="0"
                        Style="{StaticResource UserTextBlockStyle}"
                        Text="Email:" />
                    <TextBox
                        Grid.Row="0"
                        Grid.Column="2"
                        Margin="5,0"
                        Style="{StaticResource UserTextBoxStyle}"
                        Text="{Binding Mail, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" />

                    <TextBlock
                        Grid.Row="2"
                        Grid.Column="0"
                        Style="{StaticResource UserTextBlockStyle}"
                        Text="Login:" />
                    <TextBox
                        Grid.Row="2"
                        Grid.Column="2"
                        Margin="5,0"
                        Style="{StaticResource UserTextBoxStyle}"
                        Text="{Binding Login, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" />

                    <TextBlock
                        Grid.Row="4"
                        Grid.Column="0"
                        Style="{StaticResource UserTextBlockStyle}"
                        Text="Password:" />
                    <PasswordBox
                        Grid.Row="4"
                        Grid.Column="2"
                        Margin="5,0"
                        local:PasswordBoxHelper.Password="{Binding Password, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                        Style="{StaticResource AdminPasswordBoxStyle}" />

                    <TextBlock
                        Grid.Row="6"
                        Grid.Column="0"
                        Style="{StaticResource UserTextBlockStyle}"
                        Text="Name:" />
                    <TextBox
                        Grid.Row="6"
                        Grid.Column="2"
                        Margin="5,0"
                        Style="{StaticResource UserTextBoxStyle}"
                        Text="{Binding Name, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" />

                    <TextBlock
                        Grid.Row="8"
                        Grid.Column="0"
                        Style="{StaticResource UserTextBlockStyle}"
                        Text="Surname:" />
                    <TextBox
                        Grid.Row="8"
                        Grid.Column="2"
                        Margin="5,0"
                        Style="{StaticResource UserTextBoxStyle}"
                        Text="{Binding Surname, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" />

                    <TextBlock
                        Grid.Row="10"
                        Grid.Column="0"
                        Style="{StaticResource UserTextBlockStyle}"
                        Text="Patronymic:" />
                    <TextBox
                        Grid.Row="10"
                        Grid.Column="2"
                        Margin="5,0"
                        Style="{StaticResource UserTextBoxStyle}"
                        Text="{Binding Patronymic, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" />

                    <TextBlock
                        Grid.Row="12"
                        Grid.Column="0"
                        Style="{StaticResource UserTextBlockStyle}"
                        Text="Phone:" />
                    <TextBox
                        Grid.Row="12"
                        Grid.Column="2"
                        Margin="5,0"
                        Style="{StaticResource UserTextBoxStyle}"
                        Text="{Binding PhoneNumber, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" />

                    <Button
                        Grid.Row="14"
                        Grid.Column="2"
                        Command="{Binding SendFormRegistration}"
                        Content="Send"
                        IsEnabled="{Binding IsEnabledSendFormRegistration}"
                        Style="{StaticResource UserButtonStyle}" />
                </Grid>
            </StackPanel>
        </Border>

        <!--  Кастомная шапка (как в ContainerWindow)  -->
        <Border
            Height="24"
            HorizontalAlignment="Stretch"
            VerticalAlignment="Top"
            Background="#FF333333"
            MouseLeftButtonDown="TitleBar_MouseLeftButtonDown">
            <Grid HorizontalAlignment="Right">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="auto" />
                    <ColumnDefinition Width="auto" />
                    <ColumnDefinition Width="5" />
                </Grid.ColumnDefinitions>

                <!--  КНОПКА СВЕРНУТЬ  -->
                <Button
                    x:Name="MinimizeButton"
                    Grid.Column="0"
                    Width="24"
                    Margin="0,-12,0,0"
                    BorderBrush="Transparent"
                    Click="MinimizeButton_Click"
                    Content="_"
                    FontSize="24"
                    FontWeight="Bold"
                    Style="{StaticResource MinimizeButtonStyle}" />

                <!--  КНОПКА ЗАКРЫТЬ  -->
                <Button
                    x:Name="CloseButton"
                    Grid.Column="1"
                    Width="24"
                    Margin="0,-7,0,0"
                    BorderBrush="Transparent"
                    Click="CloseButton_Click"
                    Content="×"
                    FontSize="24"
                    FontWeight="Bold"
                    Style="{StaticResource CloseButtonStyle}" />
            </Grid>
        </Border>
    </Grid>
</Window>

using System.ComponentModel;
using System.Windows;
using ViewModel.ModalWindowsViewModel;
using ViewModel.Services.Interfaces;

namespace View.ModalWindows
{ 
    public partial class DeleteHumanWindowView : Window
    {
        private DeleteHumanWindowViewModel _viewModel;
        public DeleteHumanWindowView(DeleteHumanWindowViewModel viewModel)
        {
            InitializeComponent();
            DataContext = viewModel;
            _viewModel = viewModel;

            if (viewModel is IClosable closable)
            {
                closable.RequestClose += () => Close();
            }
        }
        private void TitleBar_MouseLeftButtonDown(object sender, System.Windows.Input.MouseButtonEventArgs e)
        {
            DragMove();
        }
        private void MinimizeButton_Click(object sender, RoutedEventArgs e)
        {
            WindowState = WindowState.Minimized;
        }
        private void CloseButton_Click(object sender, RoutedEventArgs e)
        {
            Close();
        }
        protected override void OnClosing(CancelEventArgs e)
        {
            base.OnClosing(e);
            if (DataContext is DeleteHumanWindowViewModel vm)
            {
                vm.ClearData();
            }
        }
    }
}

using System.Windows;
using ViewModel.ModalWindowsViewModel;
using ViewModel.Services.Interfaces;

namespace View.ModalWindows
{
    public partial class RegistrationWindowView : Window
    {
        public RegistrationWindowView(RegistrationWindowViewModel viewModel)
        {
            InitializeComponent();
            DataContext = viewModel;

            if (viewModel is IClosable closable)
            {
                closable.RequestClose += () => Close();
            }
        }
        private void TitleBar_MouseLeftButtonDown(object sender, System.Windows.Input.MouseButtonEventArgs e)
        {
            DragMove();
        }
        private void MinimizeButton_Click(object sender, RoutedEventArgs e)
        {
            WindowState = WindowState.Minimized;
        }
        private void CloseButton_Click(object sender, RoutedEventArgs e)
        {
            Close();
        }
    }
}

<Page
    x:Class="View.Pages.AdminPageView"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:helpers="clr-namespace:View.Helpers"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:pagesviewmodel="clr-namespace:ViewModel.PagesViewModel;assembly=ViewModel"
    Title="Панель администратора"
    d:DataContext="{d:DesignInstance Type=pagesviewmodel:AdminPageViewModel}"
    d:DesignHeight="720"
    d:DesignWidth="1280"
    mc:Ignorable="d">
    <Page.Resources>
        <helpers:ByteToImageConverter x:Key="ByteToImageConverter" />
    </Page.Resources>

    <Grid>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="*" />
            <ColumnDefinition Width="140" />
        </Grid.ColumnDefinitions>

        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
        </Grid.RowDefinitions>

        <StackPanel
            Grid.Row="0"
            Grid.Column="0"
            Height="50"
            Margin="6,0,0,0"
            VerticalAlignment="Top"
            Orientation="Horizontal">
            <Button
                Grid.Row="0"
                Grid.Column="1"
                Command="{Binding ExecuteQueryCommand}"
                Content="Выполнить"
                Style="{StaticResource UserButtonStyle}" />
            <TextBox
                Width="1018"
                Margin="10,5"
                AcceptsReturn="True"
                Text="{Binding InputArea}"
                VerticalScrollBarVisibility="Auto" />
        </StackPanel>

        <Button
            Grid.Row="0"
            Grid.Column="1"
            Command="{Binding LogOut}"
            Content="Выход из аккаунта"
            Style="{StaticResource UserButtonStyle}" />

        <DataGrid
            Grid.Row="1"
            Grid.Column="0"
            Margin="10"
            AutoGenerateColumns="True"
            AutoGeneratingColumn="DataGrid_AutoGeneratingColumn"
            CanUserAddRows="False"
            IsReadOnly="True"
            ItemsSource="{Binding DataTableAdmin}" />

        <Grid Grid.Row="1" Grid.Column="1">
            <StackPanel VerticalAlignment="Top" Orientation="Vertical">
                <Button
                    Command="{Binding AddUser}"
                    Content="Добавить юзера"
                    Style="{StaticResource UserButtonStyle}" />
                <Button
                    Command="{Binding UpdateUser}"
                    Content="Обновить юзера"
                    Style="{StaticResource UserButtonStyle}" />
                <Button
                    Command="{Binding DeleteUser}"
                    Content="Удалить юзера"
                    Style="{StaticResource UserButtonStyle}" />
                <Button
                    Command="{Binding AddAdmin}"
                    Content="Добавить админа"
                    Style="{StaticResource UserButtonStyle}" />
                <Button
                    Command="{Binding UpdateAdmin}"
                    Content="Обновить админа"
                    Style="{StaticResource UserButtonStyle}" />
                <Button
                    Command="{Binding DeleteAdmin}"
                    Content="Удалить админа"
                    Style="{StaticResource UserButtonStyle}" />
                <Button
                    Command="{Binding AddProduct}"
                    Content="Добавить продукт"
                    Style="{StaticResource UserButtonStyle}" />
                <Button
                    Command="{Binding UpdateProduct}"
                    Content="Обновить продукт"
                    Style="{StaticResource UserButtonStyle}" />
                <Button
                    Command="{Binding DeleteProduct}"
                    Content="Удалить продукт"
                    Style="{StaticResource UserButtonStyle}" />
                <Button
                    Command="{Binding AddCategory}"
                    Content="Добавиь категорию"
                    Style="{StaticResource UserButtonStyle}" />
                <Button
                    Command="{Binding UpdateCategory}"
                    Content="Обновить категорию"
                    Style="{StaticResource UserButtonStyle}" />
                <Button
                    Command="{Binding DeleteCategory}"
                    Content="Удалить категорию"
                    Style="{StaticResource UserButtonStyle}" />
                <Button
                    Command="{Binding AddQuantityProduct}"
                    Content="Добавить на склад"
                    Style="{StaticResource UserButtonStyle}" />
            </StackPanel>

            <StackPanel Margin="10,30" VerticalAlignment="Bottom">
                <StackPanel Orientation="Horizontal">
                    <TextBlock Style="{StaticResource UserTextBlockStyle}" Text="Login: " />
                    <TextBlock Style="{StaticResource UserTextBlockStyle}" Text="{Binding LoginAdmin}" />
                </StackPanel>
                <StackPanel Orientation="Horizontal">
                    <TextBlock Style="{StaticResource UserTextBlockStyle}" Text="Name: " />
                    <TextBlock Style="{StaticResource UserTextBlockStyle}" Text="{Binding NameAdmin}" />
                </StackPanel>
                <StackPanel Orientation="Horizontal">
                    <TextBlock Style="{StaticResource UserTextBlockStyle}" Text="Surname: " />
                    <TextBlock Style="{StaticResource UserTextBlockStyle}" Text="{Binding SurnameAdmin}" />
                </StackPanel>
                <StackPanel Orientation="Horizontal">
                    <TextBlock Style="{StaticResource UserTextBlockStyle}" Text="Email: " />
                    <TextBlock Style="{StaticResource UserTextBlockStyle}" Text="{Binding EmailAdmin}" />
                </StackPanel>
                <StackPanel Orientation="Horizontal">
                    <TextBlock Style="{StaticResource UserTextBlockStyle}" Text="Phone: " />
                    <TextBlock Style="{StaticResource UserTextBlockStyle}" Text="{Binding PhoneAdmin}" />
                </StackPanel>
            </StackPanel>
        </Grid>
    </Grid>
</Page>

<Page
    x:Class="View.Pages.LoginPageView"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:local="clr-namespace:View.Helpers"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    Title="Страница авторизации"
    d:DesignHeight="720"
    d:DesignWidth="1280"
    mc:Ignorable="d">

    <Grid
        Width="400"
        HorizontalAlignment="Center"
        VerticalAlignment="Center">
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="Auto" />
            <ColumnDefinition Width="*" />
            <ColumnDefinition Width="Auto" />
        </Grid.ColumnDefinitions>
        <Grid.RowDefinitions>
            <RowDefinition Height="*" />
            <RowDefinition Height="15" />
            <RowDefinition Height="*" />
            <RowDefinition Height="30" />
            <RowDefinition Height="*" />
        </Grid.RowDefinitions>

        <TextBlock
            Grid.Row="0"
            Grid.Column="0"
            Style="{StaticResource DefaultTextBlockStyle}"
            Text="Login:" />
        <TextBox
            Grid.Row="0"
            Grid.Column="2"
            Width="200"
            Style="{StaticResource DefaultTextBoxStyle}"
            Text="{Binding Login, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" />

        <TextBlock
            Grid.Row="2"
            Grid.Column="0"
            Style="{StaticResource DefaultTextBlockStyle}"
            Text="Password:" />
        <PasswordBox
            Grid.Row="2"
            Grid.Column="2"
            Width="200"
            local:PasswordBoxHelper.Password="{Binding Password, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
            Style="{StaticResource DefaultPasswordBoxStyle}" />

        <Button
            Grid.Row="4"
            Grid.Column="0"
            Command="{Binding NavigateToSignIn}"
            Content="Sign In"
            IsEnabled="{Binding IsEnabledNavigateToSignIn}"
            Style="{StaticResource DefaultButtonStyle}" />
        <Button
            Grid.Row="4"
            Grid.Column="2"
            Command="{Binding NavigateToRegistration}"
            Content="Registration"
            Style="{StaticResource DefaultButtonStyle}" />
    </Grid>
</Page>

<Page
    x:Class="View.Pages.RegistrationPageView"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:local="clr-namespace:View.Helpers"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:pagesviewmodel="clr-namespace:ViewModel.PagesViewModel;assembly=ViewModel"
    Title="Регистрация"
    d:DataContext="{d:DesignInstance Type=pagesviewmodel:RegistrationPageViewModel}"
    d:DesignHeight="720"
    d:DesignWidth="1280"
    mc:Ignorable="d">

    <StackPanel>
        <TextBlock
            Margin="0,50"
            HorizontalAlignment="Center"
            Style="{StaticResource DefaultTextBlockStyle}"
            Text="REGISTRATION" />

        <Grid Width="750" Height="500">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="200" />
                <ColumnDefinition Width="*" />
                <ColumnDefinition Width="500" />
            </Grid.ColumnDefinitions>
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto" />
                <RowDefinition Height="*" />
                <RowDefinition Height="Auto" />
                <RowDefinition Height="*" />
                <RowDefinition Height="Auto" />
                <RowDefinition Height="*" />
                <RowDefinition Height="Auto" />
                <RowDefinition Height="*" />
                <RowDefinition Height="Auto" />
                <RowDefinition Height="*" />
                <RowDefinition Height="Auto" />
                <RowDefinition Height="*" />
                <RowDefinition Height="Auto" />
                <RowDefinition Height="*" />
                <RowDefinition Height="Auto" />
            </Grid.RowDefinitions>

            <TextBlock
                Grid.Row="0"
                Grid.Column="0"
                Style="{StaticResource DefaultTextBlockStyle}"
                Text="Email:" />
            <TextBox
                Grid.Row="0"
                Grid.Column="2"
                Style="{StaticResource DefaultTextBoxStyle}"
                Text="{Binding Mail, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" />

            <TextBlock
                Grid.Row="2"
                Grid.Column="0"
                Style="{StaticResource DefaultTextBlockStyle}"
                Text="Login:" />
            <TextBox
                Grid.Row="2"
                Grid.Column="2"
                Style="{StaticResource DefaultTextBoxStyle}"
                Text="{Binding Login, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" />

            <TextBlock
                Grid.Row="4"
                Grid.Column="0"
                Style="{StaticResource DefaultTextBlockStyle}"
                Text="Password:" />
            <PasswordBox
                Grid.Row="4"
                Grid.Column="2"
                local:PasswordBoxHelper.Password="{Binding Password, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                Style="{StaticResource DefaultPasswordBoxStyle}" />

            <TextBlock
                Grid.Row="6"
                Grid.Column="0"
                Style="{StaticResource DefaultTextBlockStyle}"
                Text="Name:" />
            <TextBox
                Grid.Row="6"
                Grid.Column="2"
                Style="{StaticResource DefaultTextBoxStyle}"
                Text="{Binding Name, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" />

            <TextBlock
                Grid.Row="8"
                Grid.Column="0"
                Style="{StaticResource DefaultTextBlockStyle}"
                Text="Surname:" />
            <TextBox
                Grid.Row="8"
                Grid.Column="2"
                Style="{StaticResource DefaultTextBoxStyle}"
                Text="{Binding Surname, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" />

            <TextBlock
                Grid.Row="10"
                Grid.Column="0"
                Style="{StaticResource DefaultTextBlockStyle}"
                Text="Patronymic:" />
            <TextBox
                Grid.Row="10"
                Grid.Column="2"
                Style="{StaticResource DefaultTextBoxStyle}"
                Text="{Binding Patronymic, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" />

            <TextBlock
                Grid.Row="12"
                Grid.Column="0"
                Style="{StaticResource DefaultTextBlockStyle}"
                Text="Phone:" />
            <TextBox
                Grid.Row="12"
                Grid.Column="2"
                Style="{StaticResource DefaultTextBoxStyle}"
                Text="{Binding PhoneNumber, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" />

            <Button
                Grid.Row="14"
                Grid.Column="0"
                Command="{Binding BackToLoginPage}"
                Content="Back"
                Style="{StaticResource DefaultButtonStyle}" />
            <TextBlock Text="{Binding IsEnabledSendFormRegistration}" 
               Foreground="Red" 
               FontWeight="Bold" />
            <Button
                Grid.Row="14"
                Grid.Column="2"
                Command="{Binding SendFormRegistration}"
                Content="Send"
                IsEnabled="{Binding IsEnabledSendFormRegistration}"
                Background="LightGreen" />
        </Grid>

    </StackPanel>
</Page>

<Page
    x:Class="View.Pages.UserPageView"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:helpers="clr-namespace:View.Helpers"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    Title="Панель пользователя"
    d:DesignHeight="720"
    d:DesignWidth="1280"
    mc:Ignorable="d">
    <Page.Resources>
        <helpers:ByteToImageConverter x:Key="ByteToImageConverter" />
    </Page.Resources>

    <Grid>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="*" />
            <ColumnDefinition Width="140" />
        </Grid.ColumnDefinitions>

        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
        </Grid.RowDefinitions>

        <StackPanel
            Grid.Row="0"
            Grid.Column="0"
            Height="50"
            VerticalAlignment="Top"
            Orientation="Horizontal">
            <Button
                Command="{Binding ShowTop3Products}"
                Content="Показать топ 3 товара"
                Style="{StaticResource UserButtonStyle}" />
            <Button
                Command="{Binding SearchProductByName}"
                Content="Найти продукт по названию"
                Style="{StaticResource UserButtonStyle}" />
            <Button
                Command="{Binding SearchProductByPrice}"
                Content="Найти продукт по цене"
                Style="{StaticResource UserButtonStyle}" />
            <Button
                Command="{Binding ShowProductInCategory}"
                Content="Показать продукты по категории"
                Style="{StaticResource UserButtonStyle}" />
            <Button
                Command="{Binding ShowProductInPortions}"
                Content="Показать порционно продукты"
                Style="{StaticResource UserButtonStyle}" />
            <Button
                Command="{Binding SearchOrdersByDate}"
                Content="Найти заказ по дате"
                Style="{StaticResource UserButtonStyle}" />
        </StackPanel>

        <Button
            Grid.Row="0"
            Grid.Column="1"
            Command="{Binding LogOut}"
            Content="Выход из аккаунта"
            Style="{StaticResource UserButtonStyle}" />

        <DataGrid
            Grid.Row="1"
            Grid.Column="0"
            Margin="10"
            AutoGenerateColumns="True"
            AutoGeneratingColumn="DataGrid_AutoGeneratingColumn"
            CanUserAddRows="False"
            IsReadOnly="True"
            ItemsSource="{Binding Data}" />

        <Grid Grid.Row="1" Grid.Column="1">
            <StackPanel VerticalAlignment="Top" Orientation="Vertical">
                <Button
                    Command="{Binding ShowUserOrderHistory}"
                    Content="История заказов"
                    Style="{StaticResource UserButtonStyle}" />
                <Button
                    Command="{Binding CreateOrder}"
                    Content="Создать заказ"
                    Style="{StaticResource UserButtonStyle}" />
                <Button
                    Command="{Binding ShowAllProducts}"
                    Content="Показать товары"
                    Style="{StaticResource UserButtonStyle}" />
            </StackPanel>
            <StackPanel VerticalAlignment="Center" Visibility="{Binding IsPortionsFormVisible}">
                <StackPanel Orientation="Horizontal">
                    <TextBlock
                        Margin="8,0"
                        Style="{StaticResource UserTextBlockStyle}"
                        Text="Количество" />
                    <TextBox
                        Width="50"
                        Style="{StaticResource UserTextBoxStyle}"
                        Text="{Binding CountPortions, UpdateSourceTrigger=PropertyChanged, ValidatesOnExceptions=True}" />
                </StackPanel>
                <Button
                    Width="80"
                    Command="{Binding EnterCountPortions}"
                    Content="Выбрать"
                    IsEnabled="{Binding EnterCountPortionsIsEnabled}"
                    Style="{StaticResource UserButtonStyle}" />
                <StackPanel HorizontalAlignment="Center" Orientation="Horizontal">
                    <Button
                        Margin="3"
                        Padding="6,1,6,4"
                        Command="{Binding LeftArrowCountPortions}"
                        Content="←"
                        IsEnabled="{Binding EnterCountPortionsIsEnabled}"
                        Style="{StaticResource UserButtonStyle}" />
                    <Button
                        Margin="3"
                        Padding="6,1,6,4"
                        Command="{Binding RightArrowCountPortions}"
                        Content="→"
                        IsEnabled="{Binding EnterCountPortionsIsEnabled}"
                        Style="{StaticResource UserButtonStyle}" />
                </StackPanel>
            </StackPanel>
            <StackPanel Margin="10,30" VerticalAlignment="Bottom">
                <StackPanel Orientation="Horizontal">
                    <TextBlock Style="{StaticResource UserTextBlockStyle}" Text="Login: " />
                    <TextBlock Style="{StaticResource UserTextBlockStyle}" Text="{Binding LoginUser}" />
                </StackPanel>
                <StackPanel Orientation="Horizontal">
                    <TextBlock Style="{StaticResource UserTextBlockStyle}" Text="Name: " />
                    <TextBlock Style="{StaticResource UserTextBlockStyle}" Text="{Binding NameUser}" />
                </StackPanel>
                <StackPanel Orientation="Horizontal">
                    <TextBlock Style="{StaticResource UserTextBlockStyle}" Text="Surname: " />
                    <TextBlock Style="{StaticResource UserTextBlockStyle}" Text="{Binding SurnameUser}" />
                </StackPanel>
                <StackPanel Orientation="Horizontal">
                    <TextBlock Style="{StaticResource UserTextBlockStyle}" Text="Email: " />
                    <TextBlock Style="{StaticResource UserTextBlockStyle}" Text="{Binding EmailUser}" />
                </StackPanel>
                <StackPanel Orientation="Horizontal">
                    <TextBlock Style="{StaticResource UserTextBlockStyle}" Text="Phone: " />
                    <TextBlock Style="{StaticResource UserTextBlockStyle}" Text="{Binding PhoneUser}" />
                </StackPanel>
            </StackPanel>
        </Grid>
    </Grid>
</Page>

using System.Windows;
using System.Windows.Controls;
using System.Windows.Data;
using System.Windows.Media;
using ViewModel.PagesViewModel;
using View.Helpers;

namespace View.Pages;
public partial class AdminPageView : Page
{
    public AdminPageView(AdminPageViewModel viewModel)
    {
        InitializeComponent();
        DataContext = viewModel;
    }
    private void DataGrid_AutoGeneratingColumn(object sender, DataGridAutoGeneratingColumnEventArgs e)
    {
        // Проверяем ТОЛЬКО по имени столбца. Это надежнее.
        if (e.PropertyName == "Image")
        {
            // Создаём шаблонный столбец
            var templateColumn = new DataGridTemplateColumn
            {
                Header = "image", // Можно задать свой заголовок
                SortMemberPath = e.PropertyName
            };

            // Создаём DataTemplate с Image
            var factory = new FrameworkElementFactory(typeof(Image));
            factory.SetValue(Image.StretchProperty, Stretch.Uniform);
            factory.SetValue(Image.WidthProperty, 50.0);
            factory.SetValue(Image.HeightProperty, 50.0);

            // Привязка с конвертером
            var binding = new Binding(e.PropertyName)
            {
                Converter = new ByteToImageConverter() // Используем ваш существующий конвертер
            };
            factory.SetBinding(Image.SourceProperty, binding);

            var dataTemplate = new DataTemplate();
            dataTemplate.VisualTree = factory;
            templateColumn.CellTemplate = dataTemplate;

            // Заменяем стандартный столбец на шаблонный
            e.Column = templateColumn;
        }
    }
}

using System.Windows.Controls;
using ViewModel.PagesViewModel;

namespace View.Pages;
public partial class LoginPageView : Page
{
    public LoginPageView(LoginPageViewModel viewModel)
    {
        InitializeComponent();
        DataContext = viewModel;
    }
}

using System.Windows.Controls;
using ViewModel.PagesViewModel;

namespace View.Pages;
public partial class RegistrationPageView : Page
{
    public RegistrationPageView(RegistrationPageViewModel viewModel)
    {
        InitializeComponent();
        DataContext = viewModel;
    }
}

using System.Windows;
using System.Windows.Controls;
using System.Windows.Data;
using System.Windows.Media;
using View.Helpers;
using ViewModel.PagesViewModel;

namespace View.Pages;
public partial class UserPageView : Page
{
    public UserPageView(UserPageViewModel viewModel)
    {
        InitializeComponent();
        DataContext = viewModel;
    }
    private void DataGrid_AutoGeneratingColumn(object sender, DataGridAutoGeneratingColumnEventArgs e)
    {
        // Проверяем, если столбец называется "Image" и содержит byte[]
        if (e.PropertyName == "Image" && e.PropertyType == typeof(byte[]))
        {
            // Создаём шаблонный столбец
            var templateColumn = new DataGridTemplateColumn
            {
                Header = e.Column.Header,
                SortMemberPath = e.PropertyName
            };

            // Создаём DataTemplate с Image
            var factory = new FrameworkElementFactory(typeof(Image));
            factory.SetValue(Image.StretchProperty, Stretch.Uniform);
            factory.SetValue(Image.WidthProperty, 50.0);
            factory.SetValue(Image.HeightProperty, 50.0);

            // Привязка с конвертером
            var binding = new Binding(e.PropertyName)
            {
                Converter = new ByteToImageConverter()
            };
            factory.SetBinding(Image.SourceProperty, binding);

            var dataTemplate = new DataTemplate();
            dataTemplate.VisualTree = factory;
            templateColumn.CellTemplate = dataTemplate;

            // Заменяем стандартный столбец на шаблонный
            e.Column = templateColumn;
        }
    }
}

using System.Windows;
using View.ModalWindows;
using ViewModel.ModalWindowsViewModel;

public class DialogService : IDialogService
{
    public void ShowModal(object viewModel)
    {
        Window window = viewModel switch
        {
            RegistrationWindowViewModel regVm => new RegistrationWindowView(regVm),
            DeleteHumanWindowViewModel delVm => new DeleteHumanWindowView(delVm),
            _ => throw new ArgumentException($"Неизвестная ViewModel: {viewModel?.GetType().Name}")
        };

        window.Owner = Application.Current.MainWindow;
        window.ShowDialog();
    }
}

<Application
    x:Class="View.App"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml">
    <Application.Resources>
        <Style x:Key="DefaultTextBlockStyle" TargetType="TextBlock">
            <Setter Property="FontSize" Value="32" />
            <Setter Property="FontFamily" Value="Segoe UI" />
        </Style>

        <Style x:Key="UserTextBlockStyle" TargetType="TextBlock">
            <Setter Property="FontSize" Value="12" />
            <Setter Property="FontFamily" Value="Segoe UI" />
        </Style>

        <Style x:Key="DefaultTextBoxStyle" TargetType="TextBox">
            <Setter Property="FontSize" Value="24" />
            <Setter Property="Padding" Value="5" />
            <Setter Property="Margin" Value="5" />
            <Setter Property="BorderBrush" Value="Black" />
        </Style>

        <Style x:Key="UserTextBoxStyle" TargetType="TextBox">
            <Setter Property="FontSize" Value="12" />
            <Setter Property="Padding" Value="0,-1,0,0" />
            <Setter Property="BorderBrush" Value="Black" />
        </Style>

        <Style x:Key="DefaultPasswordBoxStyle" TargetType="PasswordBox">
            <Setter Property="FontSize" Value="24" />
            <Setter Property="Padding" Value="5" />
            <Setter Property="Margin" Value="5" />
            <Setter Property="BorderBrush" Value="Black" />
        </Style>

        <Style x:Key="AdminPasswordBoxStyle" TargetType="PasswordBox">
            <Setter Property="FontSize" Value="12" />
            <Setter Property="Padding" Value="0,-1,0,0" />
            <Setter Property="BorderBrush" Value="Black" />
        </Style>

        <Style x:Key="DefaultButtonStyle" TargetType="Button">
            <Setter Property="FontSize" Value="24" />
            <Setter Property="Padding" Value="10,5" />
            <Setter Property="Margin" Value="5" />
            <Setter Property="FontWeight" Value="Bold" />
            <Setter Property="BorderThickness" Value="0" />

            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border
                            x:Name="border"
                            Padding="{TemplateBinding Padding}"
                            Background="{TemplateBinding Background}">
                            <ContentPresenter
                                HorizontalAlignment="Center"
                                VerticalAlignment="Center"
                                TextElement.FontSize="{TemplateBinding FontSize}"
                                TextElement.FontWeight="Bold"
                                TextElement.Foreground="{TemplateBinding Foreground}" />
                        </Border>

                        <ControlTemplate.Triggers>
                            <!--  При наведении  -->
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="Background" Value="#11324a" />
                            </Trigger>

                            <!--  Когда кнопка НЕ активна  -->
                            <Trigger Property="IsEnabled" Value="False">
                                <Setter Property="Background" Value="#E0E0E0" />
                                <Setter Property="Foreground" Value="#A0A0A0" />
                                <Setter Property="BorderBrush" Value="#C0C0C0" />
                                <Setter Property="Cursor" Value="No" />
                            </Trigger>

                            <!--  Когда кнопка активна  -->
                            <Trigger Property="IsEnabled" Value="True">
                                <Setter Property="Background" Value="#0776c4" />
                                <Setter Property="Foreground" Value="White" />
                                <Setter Property="BorderBrush" Value="#0776c4" />
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style x:Key="UserButtonStyle" TargetType="Button">
            <Setter Property="FontSize" Value="12" />
            <Setter Property="Padding" Value="10,5" />
            <Setter Property="Margin" Value="5" />
            <Setter Property="FontWeight" Value="Bold" />
            <Setter Property="BorderThickness" Value="0" />

            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border
                            x:Name="border"
                            Padding="{TemplateBinding Padding}"
                            Background="{TemplateBinding Background}">
                            <ContentPresenter
                                HorizontalAlignment="Center"
                                VerticalAlignment="Center"
                                TextElement.FontSize="{TemplateBinding FontSize}"
                                TextElement.FontWeight="Bold"
                                TextElement.Foreground="{TemplateBinding Foreground}" />
                        </Border>

                        <ControlTemplate.Triggers>
                            <!--  При наведении  -->
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="Background" Value="#11324a" />
                            </Trigger>

                            <!--  Когда кнопка НЕ активна  -->
                            <Trigger Property="IsEnabled" Value="False">
                                <Setter Property="Background" Value="#E0E0E0" />
                                <Setter Property="Foreground" Value="#A0A0A0" />
                                <Setter Property="BorderBrush" Value="#C0C0C0" />
                                <Setter Property="Cursor" Value="No" />
                            </Trigger>

                            <!--  Когда кнопка активна  -->
                            <Trigger Property="IsEnabled" Value="True">
                                <Setter Property="Background" Value="#424547" />
                                <Setter Property="Foreground" Value="White" />
                                <Setter Property="BorderBrush" Value="#424547" />
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style x:Key="MinimizeButtonStyle" TargetType="Button">
            <Setter Property="Foreground" Value="White" />
            <Setter Property="Background" Value="Transparent" />
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border Background="{TemplateBinding Background}">
                            <ContentPresenter HorizontalAlignment="{TemplateBinding HorizontalContentAlignment}" VerticalAlignment="{TemplateBinding VerticalContentAlignment}" />
                        </Border>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
            <Style.Triggers>
                <Trigger Property="IsMouseOver" Value="True">
                    <Setter Property="Background" Value="#555555" />
                </Trigger>
            </Style.Triggers>
        </Style>

        <Style x:Key="CloseButtonStyle" TargetType="Button">
            <Setter Property="Foreground" Value="White" />
            <Setter Property="Background" Value="Transparent" />
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border Background="{TemplateBinding Background}">
                            <ContentPresenter HorizontalAlignment="{TemplateBinding HorizontalContentAlignment}" VerticalAlignment="{TemplateBinding VerticalContentAlignment}" />
                        </Border>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
            <Style.Triggers>
                <Trigger Property="IsMouseOver" Value="True">
                    <Setter Property="Background" Value="Red" />
                </Trigger>
            </Style.Triggers>
        </Style>

        <Style TargetType="Page">
            <Setter Property="Background" Value="White" />
            <Setter Property="FontFamily" Value="Segoe UI" />
            <Setter Property="Foreground" Value="Black" />
        </Style>
    </Application.Resources>
</Application>

using Microsoft.Extensions.DependencyInjection;
using System.Windows;
using System.Windows.Controls;
using View.Pages;
using ViewModel.PagesViewModel;
using ViewModel.Services.Classes;
using ViewModel.Services.Interfaces;

namespace View;

public partial class App : Application
{
    public IServiceProvider Services { get; private set; }

    public App()
    {
        var services = new ServiceCollection();
        ConfigureServices(services);
        Services = services.BuildServiceProvider();
    }

    private void ConfigureServices(IServiceCollection services)
    {
        services.AddSingleton<INavigateService, NavigateService>();
        services.AddSingleton<IDialogService, DialogService>();

        services.AddTransient<LoginPageViewModel>();
        services.AddTransient<RegistrationPageViewModel>();
        services.AddTransient<AdminPageViewModel>();
        services.AddTransient<UserPageViewModel>();
        services.AddTransient<ViewModel.ModalWindowsViewModel.RegistrationWindowViewModel>();
        services.AddTransient<ViewModel.ModalWindowsViewModel.DeleteHumanWindowViewModel>();
    }
    protected override void OnStartup(StartupEventArgs e)
    {
        try
        {
            base.OnStartup(e);

            var mainWindow = new ContainerWindow();
            var navigateService = Services.GetRequiredService<INavigateService>();

            if (navigateService == null)
                throw new InvalidOperationException("NavigateService не зарегистрирован в DI.");

            navigateService.ConfigureNavigation(mainWindow.MainFrame);

            navigateService.Navigated += (pageName) =>
            {
            Page? page = pageName switch
            {
                "LoginPageView" => CreateLoginPage(),
                "RegistrationPageView" => CreateRegistrationPage(),
                "AdminPageView" => CreateAdminPage(),
                "UserPageView" => CreateUserPage(),
                _ => null
            };

                if (page != null)
                    mainWindow.MainFrame.Navigate(page);
            };

            mainWindow.Show();

            navigateService.NavigateTo<LoginPageViewModel>();
        }
        catch (Exception ex)
        {
            MessageBox.Show(
                $"Ошибка при запуске приложения:\n{ex.Message}\n\nСтек:\n{ex.StackTrace}",
                "Критическая ошибка",
                MessageBoxButton.OK,
                MessageBoxImage.Error);

            Current.Shutdown(-1);
        }
    }

    // Вспомогательные методы!
    private Page CreateLoginPage() =>
        new LoginPageView(Services.GetRequiredService<LoginPageViewModel>());

    private Page CreateRegistrationPage() =>
        new RegistrationPageView(Services.GetRequiredService<RegistrationPageViewModel>());

    private Page CreateAdminPage() =>
        new AdminPageView(Services.GetRequiredService<AdminPageViewModel>());

    private Page CreateUserPage() =>
        new UserPageView(Services.GetRequiredService<UserPageViewModel>());
}

// ViewModel/Core/AsyncRelayCommand.cs
using System.Windows;
using System.Windows.Input;

namespace ViewModel.Core
{
    public class AsyncRelayCommand : ICommand
    {
        private readonly Func<Task> _execute;
        private readonly Func<bool> _canExecute;

        public event EventHandler CanExecuteChanged
        {
            add => CommandManager.RequerySuggested += value;
            remove => CommandManager.RequerySuggested -= value;
        }

        public AsyncRelayCommand(Func<Task> execute, Func<bool> canExecute = null)
        {
            _execute = execute ?? throw new ArgumentNullException(nameof(execute));
            _canExecute = canExecute;
        }

        public bool CanExecute(object parameter) => _canExecute?.Invoke() ?? true;

        public async void Execute(object parameter)
        {
            if (CanExecute(parameter))
            {
                try
                {
                    await _execute();
                }
                catch (Exception ex)
                {
                    MessageBox.Show($"Ошибка команды: {ex.Message}");
                }
            }
        }
    }
}

using System.Runtime.CompilerServices;

namespace ViewModel.Core;
public abstract class BasePageViewModel : ObservableObject
{
    protected bool Set<T>(ref T field, T value, [CallerMemberName] string propertyName = null)
    {
        if (EqualityComparer<T>.Default.Equals(field, value)) return false;
        field = value;
        OnPropertyChanged(propertyName);
        return true;
    }
}

#nullable enable
using System.ComponentModel;
using System.Runtime.CompilerServices;

namespace ViewModel.Core;
public class ObservableObject : INotifyPropertyChanged
{
    public string? Title { get; set; }

    public event PropertyChangedEventHandler? PropertyChanged;
    public void OnPropertyChanged([CallerMemberName] string prop = "")
    {
        Console.WriteLine($"[INPC] PropertyChanged: {prop}");
        PropertyChanged?.Invoke(this, new PropertyChangedEventArgs(prop));
    }
}

#nullable enable
using System.Windows.Input;

namespace ViewModel.Core;

public class RelayCommand(Action<object?> execute, Func<object?, bool>? canExecute = null) : ICommand
{
    public event EventHandler? CanExecuteChanged
    {
        add { CommandManager.RequerySuggested += value; }
        remove { CommandManager.RequerySuggested -= value; }
    }
    public bool CanExecute(object? parameter)
    {
        return canExecute == null || canExecute(parameter);
    }
    public void Execute(object? parameter)
    {
        execute(parameter);
    }
}

#nullable enable
using System.Windows;
using System.Windows.Input;
using ViewModel.Core;
using ViewModel.Models;
using ViewModel.Services.Classes;
using ViewModel.Services.Interfaces;

namespace ViewModel.ModalWindowsViewModel
{
    public class DeleteHumanWindowViewModel : BasePageViewModel, IClosable
    {
        private readonly ApiHumanService _apiService = new();
        public event Action? RequestClose;

        public ICommand SearchHuman { get; }
        public ICommand DeleteHuman { get; }

        private int _id;
        public int Id
        {
            get => _id;
            set
            {
                Set(ref _id, value);
                UpdateSearchButtonState();
            }
        }

        private HumanDto? _foundHuman;
        public string? Login => _foundHuman?.Login;
        public string? Name => _foundHuman?.Name;
        public string? Surname => _foundHuman?.Surname;
        public string? Patronymic => _foundHuman?.Patronymic;
        public string? Email => _foundHuman?.Mail;
        public string? Phone => _foundHuman?.PhoneNumber;

        private string _humanType = "user";
        public string HumanType
        {
            get => _humanType;
            set => _humanType = value;
        }

        public DeleteHumanWindowViewModel()
        {
            SearchHuman = new AsyncRelayCommand(OnSearch);
            DeleteHuman = new AsyncRelayCommand(OnDelete);
        }

        public void ClearData()
        {
            Id = 0;
            _foundHuman = null;
            RefreshHumanProperties();
        }

        private async Task OnSearch()
        {
            if (Id <= 0) return;

            try
            {
                var human = await _apiService.GetHumanByIdAsync(Id, HumanType);
                if (human != null)
                {
                    _foundHuman = human;
                    RefreshHumanProperties();
                    UpdateDeleteButtonState();
                }
                else
                {
                    MessageBox.Show("Пользователь не найден");
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Ошибка поиска: {ex.Message}");
            }
        }

        private async Task OnDelete()
        {
            if (_foundHuman == null) return;

            try
            {
                var success = await _apiService.DeleteHumanAsync(_foundHuman.Id, HumanType);
                if (success)
                {
                    MessageBox.Show("Пользователь удалён");
                    _foundHuman = null;
                    RefreshHumanProperties();
                    RequestClose?.Invoke();
                }
                else
                {
                    MessageBox.Show("Не удалось удалить пользователя");
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Ошибка удаления: {ex.Message}");
            }
        }

        private void UpdateSearchButtonState()
        {
            IsEnabledIdInput = Id > 0;
        }

        private void UpdateDeleteButtonState()
        {
            IsEnabledFormDelete = _foundHuman != null;
        }

        private void RefreshHumanProperties()
        {
            OnPropertyChanged(nameof(Login));
            OnPropertyChanged(nameof(Name));
            OnPropertyChanged(nameof(Surname));
            OnPropertyChanged(nameof(Patronymic));
            OnPropertyChanged(nameof(Email));
            OnPropertyChanged(nameof(Phone));
        }

        private bool _isEnabledIdInput;
        public bool IsEnabledIdInput
        {
            get => _isEnabledIdInput;
            set { Set(ref _isEnabledIdInput, value); }
        }

        private bool _isEnabledFormDelete;
        public bool IsEnabledFormDelete
        {
            get => _isEnabledFormDelete;
            set { Set(ref _isEnabledFormDelete, value); }
        }
    }
}

#nullable enable
using System.Windows;
using System.Windows.Input;
using ViewModel.Core;
using ViewModel.Models;
using ViewModel.Services;
using ViewModel.Services.Interfaces;

namespace ViewModel.ModalWindowsViewModel
{
    public class RegistrationWindowViewModel : BasePageViewModel, IClosable
    {
        private readonly ApiRegistrationService _registrationService = new();
        public ICommand SendFormRegistration { get; }
        public event Action? RequestClose;

        private string _login = "";
        private string _password = "";
        private string _name = "";
        private string _surname = "";
        private string _patronymic = "";
        private string _mail = "";
        private string _phoneNumber = "";
        private string _humanType = "user";

        public string Login
        {
            get => _login;
            set { Set(ref _login, value); UpdateSendButtonState(); }
        }

        public string Password
        {
            get => _password;
            set { Set(ref _password, value); UpdateSendButtonState(); }
        }

        public string Name
        {
            get => _name;
            set { Set(ref _name, value); UpdateSendButtonState(); }
        }

        public string Surname
        {
            get => _surname;
            set { Set(ref _surname, value); UpdateSendButtonState(); }
        }

        public string Patronymic
        {
            get => _patronymic;
            set { Set(ref _patronymic, value); UpdateSendButtonState(); }
        }

        public string Mail
        {
            get => _mail;
            set { Set(ref _mail, value); UpdateSendButtonState(); }
        }

        public string PhoneNumber
        {
            get => _phoneNumber;
            set { Set(ref _phoneNumber, value); UpdateSendButtonState(); }
        }

        private bool _isEnabledSendFormRegistration;
        public bool IsEnabledSendFormRegistration
        {
            get => _isEnabledSendFormRegistration;
            set => Set(ref _isEnabledSendFormRegistration, value);
        }

        public RegistrationWindowViewModel()
        {
            SendFormRegistration = new AsyncRelayCommand(OnSendForm);
            // Инициализируем начальное состояние кнопки
            UpdateSendButtonState();
        }

        private async Task OnSendForm()
        {
            if (string.IsNullOrWhiteSpace(Login) ||
                string.IsNullOrWhiteSpace(Password) ||
                string.IsNullOrWhiteSpace(Name) ||
                string.IsNullOrWhiteSpace(Surname) ||
                string.IsNullOrWhiteSpace(Mail))
            {
                MessageBox.Show("Заполните обязательные поля.");
                return;
            }

            var request = new RegisterRequest
            {
                Login = Login,
                Password = Password,
                Name = Name,
                Surname = Surname,
                Patronymic = Patronymic,
                Mail = Mail,
                PhoneNumber = PhoneNumber,
                HumanType = _humanType
            };

            try
            {
                int newId = await _registrationService.RegisterAsync(request);

                if (newId > 0)
                {
                    MessageBox.Show($"Регистрация успешна! ID: {newId}");
                    RequestClose?.Invoke();
                }
                else
                {
                    MessageBox.Show("Ошибка при регистрации.");
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show("Ошибка: " + ex.Message);
            }
        }

        private void UpdateSendButtonState()
        {
            bool isValid = !string.IsNullOrWhiteSpace(Login) 
                && !string.IsNullOrWhiteSpace(Password)
                && !string.IsNullOrWhiteSpace(Name)
                && !string.IsNullOrWhiteSpace(Surname)
                && !string.IsNullOrWhiteSpace(Mail);

            // Явно устанавливаем значение
            IsEnabledSendFormRegistration = isValid;

            // Для отладки (удалить потом)
            Console.WriteLine($"[DEBUG] Button enabled: {isValid}");
        }

        public void SetHumanType(string humanType)
        {
            _humanType = humanType;
        }        
    }
}

#nullable enable
namespace ViewModel.Models;

public class HumanDto
{
    public int Id { get; set; }
    public string Login { get; set; } = string.Empty;
    public string Name { get; set; } = string.Empty;
    public string Surname { get; set; } = string.Empty;
    public string? Patronymic { get; set; }
    public string Mail { get; set; } = string.Empty;
    public string? PhoneNumber { get; set; }
}

namespace ViewModel.Models
{
    public class LoginRequest
    {
        public string Login { get; set; } = string.Empty;
        public string Password { get; set; } = string.Empty;
    }
}

namespace ViewModel.Models
{
    public class LoginResponse
    {
        public int Id { get; set; }
        public string Login { get; set; } = string.Empty;
        public string Name { get; set; } = string.Empty;
        public string Surname { get; set; } = string.Empty;
        public string Type { get; set; } = string.Empty;
    }
}

#nullable enable
namespace ViewModel.Models;

public class RegisterRequest
{
    public string Login { get; set; } = string.Empty;
    public string Password { get; set; } = string.Empty;
    public string Name { get; set; } = string.Empty;
    public string Surname { get; set; } = string.Empty;
    public string? Patronymic { get; set; }
    public string Mail { get; set; } = string.Empty;
    public string? PhoneNumber { get; set; }
    public string HumanType { get; set; } = "user"; // "user" или "admin"
}

#nullable enable
using System.Data;
using System.Windows.Input;
using ViewModel.Core;
using ViewModel.ModalWindowsViewModel;
using ViewModel.Services;
using ViewModel.Services.Interfaces;

namespace ViewModel.PagesViewModel
{
    public class AdminPageViewModel : BasePageViewModel
    {
        public AdminPageViewModel() { } // Для дизайнера XAML

        private readonly ApiAdminService _apiService = new();
        private readonly INavigateService? _navigateService;

        // Данные администратора
        public string? LoginAdmin { get; set; }
        public string? NameAdmin { get; set; }
        public string? SurnameAdmin { get; set; }
        public string? EmailAdmin { get; set; }
        public string? PhoneAdmin { get; set; }

        // Команды (обязательно инициализируем!)
        public ICommand LogOut { get; private set; } = null!;
        public ICommand AddUser { get; private set; } = null!;
        public ICommand UpdateUser { get; private set; } = null!;
        public ICommand DeleteUser { get; private set; } = null!;
        public ICommand AddAdmin { get; private set; } = null!;
        public ICommand UpdateAdmin { get; private set; } = null!;
        public ICommand DeleteAdmin { get; private set; } = null!;
        public ICommand AddProduct { get; private set; } = null!;
        public ICommand UpdateProduct { get; private set; } = null!;
        public ICommand DeleteProduct { get; private set; } = null!;
        public ICommand AddCategory { get; private set; } = null!;
        public ICommand UpdateCategory { get; private set; } = null!;
        public ICommand DeleteCategory { get; private set; } = null!;
        public ICommand AddQuantityProduct { get; private set; } = null!;
        public ICommand ExecuteQueryCommand { get; private set; } = null!;

        // SQL-запрос
        private string _inputArea = "";
        public string InputArea
        {
            get => _inputArea;
            set { Set(ref _inputArea, value); }
        }

        // Результат запроса
        private DataTable _dataTableAdmin = new();
        public DataTable DataTableAdmin
        {
            get => _dataTableAdmin;
            set { Set(ref _dataTableAdmin, value); }
        }

        // Конструктор для DI
        public AdminPageViewModel(INavigateService navigateService)
        {
            _navigateService = navigateService;

            // Обязательная инициализация всех команд
            LogOut = new RelayCommand(_ => OnLogOut());
            AddUser = new RelayCommand(_ => OnAddUser());
            UpdateUser = new RelayCommand(_ => { });
            DeleteUser = new RelayCommand(_ => OnDeleteUser());
            AddAdmin = new RelayCommand(_ => OnAddAdmin());
            UpdateAdmin = new RelayCommand(_ => { });
            DeleteAdmin = new RelayCommand(_ => OnDeleteAdmin());
            AddProduct = new RelayCommand(_ => { });
            UpdateProduct = new RelayCommand(_ => { });
            DeleteProduct = new RelayCommand(_ => { });
            AddCategory = new RelayCommand(_ => { });
            UpdateCategory = new RelayCommand(_ => { });
            DeleteCategory = new RelayCommand(_ => { });
            AddQuantityProduct = new RelayCommand(_ => { });
            ExecuteQueryCommand = new RelayCommand(_ => ExecuteQuery());
        }

        private void OnLogOut()
        {
            _navigateService?.NavigateTo<LoginPageViewModel>();
        }

        private void OnAddUser()
        {
            var vm = new RegistrationWindowViewModel();
            vm.SetHumanType("user");
        }

        private void OnDeleteUser()
        {
            var vm = new DeleteHumanWindowViewModel();
            vm.HumanType = "user";
        }

        private void OnAddAdmin()
        {
            var vm = new RegistrationWindowViewModel();
            vm.SetHumanType("admin");
        }

        private void OnDeleteAdmin()
        {
            var vm = new DeleteHumanWindowViewModel();
            vm.HumanType = "admin";
        }

        private async void ExecuteQuery()
        {
            try
            {
                var result = await _apiService.ExecuteSqlQueryAsync(InputArea);
                DataTableAdmin = result;
            }
            catch (Exception ex)
            {
                var errorTable = new DataTable();
                errorTable.Columns.Add("Ошибка", typeof(string));
                errorTable.Rows.Add(ex.Message);
                DataTableAdmin = errorTable;
            }
        }
    }
}

using System.Windows;
using System.Windows.Input;
using ViewModel.Core;
using ViewModel.Services.Classes;
using ViewModel.Services.Interfaces;

namespace ViewModel.PagesViewModel;
public class LoginPageViewModel : BasePageViewModel
{
    public LoginPageViewModel() { } // Для дизайнера

    private readonly INavigateService _navigateService;
    private readonly ApiAuthService _authService = new(); // ← HTTP-клиент

    public ICommand NavigateToSignIn { get; }
    public ICommand NavigateToRegistration { get; }

    public LoginPageViewModel(INavigateService navigateService)
    {
        _navigateService = navigateService;
        NavigateToSignIn = new RelayCommand(async _ => await OnLoginAsync());
        NavigateToRegistration = new RelayCommand(_ => navigateService.NavigateTo<RegistrationPageViewModel>());
    }

    private string _login = "";
    private string _password = "";

    public string Login
    {
        get => _login;
        set { Set(ref _login, value); UpdateSignInButtonState(); }
    }

    public string Password
    {
        get => _password;
        set { Set(ref _password, value); UpdateSignInButtonState(); }
    }

    private bool _isEnabledNavigateToSignIn;
    public bool IsEnabledNavigateToSignIn
    {
        get => _isEnabledNavigateToSignIn;
        set { Set(ref _isEnabledNavigateToSignIn, value); }
    }

    private void UpdateSignInButtonState()
    {
        IsEnabledNavigateToSignIn = !string.IsNullOrWhiteSpace(Login) &&
                                   !string.IsNullOrWhiteSpace(Password);
    }

    private async Task OnLoginAsync()
    {
        if (string.IsNullOrWhiteSpace(Login) || string.IsNullOrWhiteSpace(Password))
        {
            MessageBox.Show("Заполните обязательные поля.");
            return;
        }

        try
        {
            var user = await _authService.LoginAsync(Login, Password);

            if (user != null)
            {
                // Сохрани данные пользователя (например, в статическом классе или сервисе)
                CurrentUser.Instance.SetUser(user);

                if (user.Type == "admin")
                    _navigateService.NavigateTo<AdminPageViewModel>();
                else
                    _navigateService.NavigateTo<UserPageViewModel>();
            }
            else
            {
                MessageBox.Show("Неверный логин или пароль.");
            }
        }
        catch (Exception ex)
        {
            MessageBox.Show($"Ошибка: {ex.Message}");
        }
    }
}

using System.Windows;
using System.Windows.Input;
using ViewModel.Core;
using ViewModel.Models;
using ViewModel.Services;
using ViewModel.Services.Interfaces;

namespace ViewModel.PagesViewModel
{
    public class RegistrationPageViewModel : BasePageViewModel
    {
        public RegistrationPageViewModel() {
            SendFormRegistration = new AsyncRelayCommand(OnSendForm);
            UpdateSendButtonState();
        } // Для дизайнера XAML

        private readonly INavigateService _navigateService;
        private readonly ApiRegistrationService _registrationService = new();

        public ICommand BackToLoginPage { get; }
        public ICommand SendFormRegistration { get; }

        private string _login = "";
        private string _password = "";
        private string _name = "";
        private string _surname = "";
        private string _patronymic = "";
        private string _mail = "";
        private string _phoneNumber = "";

        public RegistrationPageViewModel(INavigateService navigateService)
        {
            _navigateService = navigateService;
            BackToLoginPage = new RelayCommand(_ => _navigateService.NavigateTo<LoginPageViewModel>());
            SendFormRegistration = new AsyncRelayCommand(OnSendForm); // ← Без скобок!
            UpdateSendButtonState();
        }

        private async Task OnSendForm()
        {
            if (string.IsNullOrWhiteSpace(Login) ||
                string.IsNullOrWhiteSpace(Password) ||
                string.IsNullOrWhiteSpace(Name) ||
                string.IsNullOrWhiteSpace(Surname) ||
                string.IsNullOrWhiteSpace(Mail))
            {
                MessageBox.Show("Заполните обязательные поля.");
                return;
            }

            var request = new RegisterRequest
            {
                Login = Login,
                Password = Password,
                Name = Name,
                Surname = Surname,
                Patronymic = Patronymic,
                Mail = Mail,
                PhoneNumber = PhoneNumber,
                HumanType = "user" // или "admin" если нужно
            };

            try
            {
                int newId = await _registrationService.RegisterAsync(request);

                if (newId > 0)
                {
                    MessageBox.Show($"Регистрация успешна! ID: {newId}");
                    _navigateService.NavigateTo<LoginPageViewModel>();
                }
                else
                {
                    MessageBox.Show("Ошибка при регистрации.");
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show("Ошибка: " + ex.Message);
            }
        }

        public string Login
        {
            get => _login;
            set { Set(ref _login, value); UpdateSendButtonState(); }
        }

        public string Password
        {
            get => _password;
            set { Set(ref _password, value); UpdateSendButtonState(); }
        }

        public string Name
        {
            get => _name;
            set { Set(ref _name, value); UpdateSendButtonState(); }
        }

        public string Surname
        {
            get => _surname;
            set { Set(ref _surname, value); UpdateSendButtonState(); }
        }

        public string Patronymic
        {
            get => _patronymic;
            set { Set(ref _patronymic, value); UpdateSendButtonState(); }
        }

        public string Mail
        {
            get => _mail;
            set { Set(ref _mail, value); UpdateSendButtonState(); }
        }

        public string PhoneNumber
        {
            get => _phoneNumber;
            set { Set(ref _phoneNumber, value); UpdateSendButtonState(); }
        }

        private void UpdateSendButtonState()
        {
            bool newValue = !string.IsNullOrWhiteSpace(Login)
                                        && !string.IsNullOrWhiteSpace(Password)
                                        && !string.IsNullOrWhiteSpace(Name)
                                        && !string.IsNullOrWhiteSpace(Surname)
                                        && !string.IsNullOrWhiteSpace(Mail);

            Console.WriteLine($"[DEBUG] Login: '{Login}', Password: '{Password}', newValue = {newValue}");

            if (_isEnabledSendFormRegistration != newValue)
            {
                _isEnabledSendFormRegistration = newValue;
                OnPropertyChanged(nameof(IsEnabledSendFormRegistration));
            }
        }

        private bool _isEnabledSendFormRegistration;
        public bool IsEnabledSendFormRegistration
        {
            get => _isEnabledSendFormRegistration;
            set
            {
                if (_isEnabledSendFormRegistration != value)
                {
                    _isEnabledSendFormRegistration = value;
                    OnPropertyChanged(nameof(IsEnabledSendFormRegistration));
                }
            }
        }
    }
}

#nullable enable
using System.Data;
using System.IO;
using System.Windows;
using System.Windows.Input;
using System.Windows.Media.Imaging;
using ViewModel.Core;
using ViewModel.Services;
using ViewModel.Services.Interfaces;

namespace ViewModel.PagesViewModel
{
    public class UserPageViewModel : BasePageViewModel
    {
        public UserPageViewModel() { // Для дизайнера XAML
            LogOut = new RelayCommand(_ => { });
            ShowTop3Products = new AsyncRelayCommand(async () => { });
            SearchProductByName = new RelayCommand(_ => { });
            SearchProductByPrice = new RelayCommand(_ => { });
            ShowProductInCategory = new RelayCommand(_ => { });
            ShowProductInPortions = new RelayCommand(_ => { });
            SearchOrdersByDate = new RelayCommand(_ => { });
            ShowUserOrderHistory = new AsyncRelayCommand(async () => { });
            CreateOrder = new RelayCommand(_ => { });
            ShowAllProducts = new RelayCommand(_ => { });
            EnterCountPortions = new AsyncRelayCommand(async () => { });
            LeftArrowCountPortions = new AsyncRelayCommand(async () => { });
            RightArrowCountPortions = new AsyncRelayCommand(async () => { });
        } 

        private readonly INavigateService? _navigateService;
        private readonly ApiUserService _apiService = new();

        // Данные пользователя
        public string? LoginUser { get; set; }
        public string? NameUser { get; set; }
        public string? SurnameUser { get; set; }
        public string? EmailUser { get; set; }
        public string? PhoneUser { get; set; }

        // Команды
        public ICommand LogOut { get; private set; }
        public ICommand ShowTop3Products { get; private set; }
        public ICommand SearchProductByName { get; private set; }
        public ICommand SearchProductByPrice { get; private set; }
        public ICommand ShowProductInCategory { get; private set; }
        public ICommand ShowProductInPortions { get; private set; }
        public ICommand SearchOrdersByDate { get; private set; }
        public ICommand ShowUserOrderHistory { get; private set; }
        public ICommand CreateOrder { get; private set; }
        public ICommand ShowAllProducts { get; private set; }
        public ICommand EnterCountPortions { get; private set; }
        public ICommand LeftArrowCountPortions { get; private set; }
        public ICommand RightArrowCountPortions { get; private set; }

        // Пагинация
        private int _skipRows = 0;
        private int _countPortions;
        public int CountPortions
        {
            get => _countPortions;
            set { Set(ref _countPortions, value); UpdateCountPortionsButtonState(); }
        }

        // Данные для отображения
        private DataTable _data = new();
        public DataTable Data
        {
            get => _data;
            set { Set(ref _data, value); }
        }

        // Видимость формы пагинации
        private Visibility _isPortionsFormVisible = Visibility.Collapsed;
        public Visibility IsPortionsFormVisible
        {
            get => _isPortionsFormVisible;
            set { Set(ref _isPortionsFormVisible, value); }
        }

        // Состояние кнопки
        private bool _enterCountPortionsIsEnabled;
        public bool EnterCountPortionsIsEnabled
        {
            get => _enterCountPortionsIsEnabled;
            set { Set(ref _enterCountPortionsIsEnabled, value); }
        }

        // Основной конструктор
        public UserPageViewModel(INavigateService navigateService) : this()
        {
            _navigateService = navigateService;

            // Перенастройка команд с реальной логикой
            LogOut = new RelayCommand(_ => OnLogOut());
            ShowTop3Products = new AsyncRelayCommand(async () => await OnShowTop3Products());
            SearchProductByName = new RelayCommand(_ => { });
            SearchProductByPrice = new RelayCommand(_ => { });
            ShowProductInCategory = new RelayCommand(_ => { });
            ShowProductInPortions = new RelayCommand(_ => OnShowProductInPortions());
            SearchOrdersByDate = new RelayCommand(_ => { });
            ShowUserOrderHistory = new AsyncRelayCommand(async () => await OnShowUserOrderHistory());
            CreateOrder = new RelayCommand(_ => { });
            ShowAllProducts = new RelayCommand(_ => { });
            EnterCountPortions = new AsyncRelayCommand(async () => await OnEnterCountPortions());
            LeftArrowCountPortions = new AsyncRelayCommand(async () => await OnLeftArrowCountPortions());
            RightArrowCountPortions = new AsyncRelayCommand(async () => await OnRightArrowCountPortions());
        }

        private void OnLogOut()
        {
            IsPortionsFormVisible = Visibility.Collapsed;
            if (_navigateService != null)
                _navigateService.NavigateTo<LoginPageViewModel>();
        }

        private async Task OnShowTop3Products()
        {
            try
            {
                IsPortionsFormVisible = Visibility.Collapsed;
                var result = await _apiService.GetTop3ProductsAsync();
                Data = result;
            }
            catch (Exception ex)
            {
                MessageBox.Show("Ошибка: " + ex.Message);
            }
        }

        private void OnShowProductInPortions()
        {
            try
            {
                IsPortionsFormVisible = Visibility.Visible;
            }
            catch (Exception ex)
            {
                MessageBox.Show("Ошибка: " + ex.Message);
            }
        }

        private async Task OnEnterCountPortions()
        {
            try
            {
                var result = await _apiService.GetShowProductsInPortionsAsync(_skipRows, CountPortions);
                Data = result;
            }
            catch (Exception ex)
            {
                MessageBox.Show("Ошибка: " + ex.Message);
            }
        }

        private async Task OnLeftArrowCountPortions()
        {
            try
            {
                if (_skipRows > 0)
                {
                    _skipRows -= CountPortions;
                    if (_skipRows < 0) _skipRows = 0;
                }
                var result = await _apiService.GetShowProductsInPortionsAsync(_skipRows, CountPortions);
                Data = result;
            }
            catch (Exception ex)
            {
                MessageBox.Show("Ошибка: " + ex.Message);
            }
        }

        private async Task OnRightArrowCountPortions()
        {
            try
            {
                var totalCount = await _apiService.GetTotalProductsCountAsync();
                if (_skipRows + CountPortions < totalCount)
                {
                    _skipRows += CountPortions;
                    var result = await _apiService.GetShowProductsInPortionsAsync(_skipRows, CountPortions);
                    Data = result;
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show("Ошибка: " + ex.Message);
            }
        }

        private async Task OnShowUserOrderHistory()
        {
            try
            {
                IsPortionsFormVisible = Visibility.Collapsed;
                var result = await _apiService.GetUserOrderHistoryAsync();
                Data = result;
            }
            catch (Exception ex)
            {
                MessageBox.Show("Ошибка: " + ex.Message);
            }
        }

        private void UpdateCountPortionsButtonState()
        {
            EnterCountPortionsIsEnabled = CountPortions > 0;
        }

        // Изображения
        private byte[]? _imageData;
        public byte[]? ImageData
        {
            get => _imageData;
            set { Set(ref _imageData, value); }
        }

        public BitmapImage? Image
        {
            get
            {
                if (_imageData == null || _imageData.Length == 0)
                    return null;

                try
                {
                    var image = new BitmapImage();
                    using (var stream = new MemoryStream(_imageData))
                    {
                        image.BeginInit();
                        image.StreamSource = stream;
                        image.CacheOption = BitmapCacheOption.OnLoad;
                        image.EndInit();
                        image.Freeze();
                    }
                    return image;
                }
                catch
                {
                    return null;
                }
            }
        }
    }
}

using System.Data;
using System.Net.Http;
using System.Text;
using System.Text.Json;

namespace ViewModel.Services
{
    public class ApiAdminService
    {
        private readonly HttpClient _httpClient = new();
        private readonly string _baseUrl = "http://localhost:5000";

        public async Task<DataTable> ExecuteSqlQueryAsync(string query)
        {
            try
            {
                var request = new { sqlQuery = query };
                var json = JsonSerializer.Serialize(request);
                var content = new StringContent(json, Encoding.UTF8, "application/json");

                var response = await _httpClient.PostAsync($"{_baseUrl}/api/admin/execute-query", content);

                if (response.IsSuccessStatusCode)
                {
                    var responseJson = await response.Content.ReadAsStringAsync();
                    // Здесь должна быть логика преобразования JSON в DataTable
                    // Для простоты возвращаем пустую таблицу
                    return new DataTable();
                }
                else
                {
                    var errorTable = new DataTable();
                    errorTable.Columns.Add("Ошибка", typeof(string));
                    errorTable.Rows.Add($"HTTP ошибка: {response.StatusCode}");
                    return errorTable;
                }
            }
            catch (Exception ex)
            {
                var errorTable = new DataTable();
                errorTable.Columns.Add("Ошибка", typeof(string));
                errorTable.Rows.Add(ex.Message);
                return errorTable;
            }
        }
    }
}

#nullable enable
using System.Net.Http;
using System.Text;
using System.Text.Json;
using ViewModel.Models;

namespace ViewModel.Services.Classes;

public class ApiAuthService
{
    private readonly HttpClient _httpClient;
    private readonly string _baseUrl = "http://localhost:5000";

    public ApiAuthService()
    {
        _httpClient = new HttpClient();
        _httpClient.DefaultRequestHeaders.Add("Accept", "application/json");
    }

    public async Task<LoginResponse?> LoginAsync(string login, string password)
    {
        var request = new LoginRequest { Login = login, Password = password };
        var json = JsonSerializer.Serialize(request);
        var content = new StringContent(json, Encoding.UTF8, "application/json");

        try
        {
            var response = await _httpClient.PostAsync($"{_baseUrl}/api/auth/login", content);

            if (response.IsSuccessStatusCode)
            {
                var responseJson = await response.Content.ReadAsStringAsync();
                return JsonSerializer.Deserialize<LoginResponse>(responseJson);
            }
            return null;
        }
        catch (Exception ex)
        {
            // Логирование ошибки (опционально)
            Console.WriteLine($"Ошибка API: {ex.Message}");
            return null;
        }
    }
}

#nullable enable
using System.Net.Http;
using System.Text.Json;
using ViewModel.Models;

namespace ViewModel.Services.Classes;

public class ApiHumanService
{
    private readonly HttpClient _httpClient;
    private readonly string _baseUrl = "http://localhost:5000";

    public ApiHumanService()
    {
        _httpClient = new HttpClient();
        _httpClient.DefaultRequestHeaders.Add("Accept", "application/json");
    }

    public async Task<HumanDto?> GetHumanByIdAsync(int id, string humanType)
    {
        try
        {
            var response = await _httpClient.GetAsync($"{_baseUrl}/api/{humanType}s/{id}");
            if (response.IsSuccessStatusCode)
            {
                var json = await response.Content.ReadAsStringAsync();
                return JsonSerializer.Deserialize<HumanDto>(json);
            }
            return null;
        }
        catch
        {
            return null;
        }
    }

    public async Task<bool> DeleteHumanAsync(int id, string humanType)
    {
        try
        {
            var response = await _httpClient.DeleteAsync($"{_baseUrl}/api/{humanType}s/{id}");
            return response.IsSuccessStatusCode;
        }
        catch
        {
            return false;
        }
    }
}

using System.Net.Http;
using System.Text;
using System.Text.Json;
using ViewModel.Models;

namespace ViewModel.Services
{
    public class ApiRegistrationService
    {
        private readonly HttpClient _httpClient = new();
        private readonly string _baseUrl = "http://localhost:5000";

        public async Task<int> RegisterAsync(RegisterRequest request)
        {
            var json = JsonSerializer.Serialize(request);
            var content = new StringContent(json, Encoding.UTF8, "application/json");

            var response = await _httpClient.PostAsync($"{_baseUrl}/api/users/register", content);

            if (response.IsSuccessStatusCode)
            {
                var responseJson = await response.Content.ReadAsStringAsync();
                using var doc = JsonDocument.Parse(responseJson);
                if (doc.RootElement.TryGetProperty("Id", out var idElement))
                    return idElement.GetInt32();
            }
            return -1;
        }
    }
}

using System.Data;
using System.Net.Http;
using System.Text.Json;

namespace ViewModel.Services
{
    public class ApiUserService
    {
        private readonly HttpClient _httpClient = new();
        private readonly string _baseUrl = "http://localhost:5000";

        public async Task<DataTable> GetTop3ProductsAsync()
        {
            try
            {
                var response = await _httpClient.GetAsync($"{_baseUrl}/api/products/top3");
                if (response.IsSuccessStatusCode)
                {
                    var json = await response.Content.ReadAsStringAsync();
                    return JsonToDataTable(json);
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Ошибка: {ex.Message}");
            }
            return new DataTable();
        }

        // Вспомогательный метод для преобразования JSON в DataTable
        private DataTable JsonToDataTable(string json)
        {
            var table = new DataTable();
            using var doc = JsonDocument.Parse(json);
            var root = doc.RootElement;

            if (root.ValueKind == JsonValueKind.Array)
            {
                foreach (var item in root.EnumerateArray())
                {
                    if (table.Columns.Count == 0)
                    {
                        foreach (var prop in item.EnumerateObject())
                        {
                            table.Columns.Add(prop.Name, typeof(string));
                        }
                    }

                    var row = table.NewRow();
                    foreach (var prop in item.EnumerateObject())
                    {
                        row[prop.Name] = prop.Value.ToString();
                    }
                    table.Rows.Add(row);
                }
            }
            return table;
        }

        public async Task<DataTable> GetShowProductsInPortionsAsync(int skipRows, int count)
        {
            var response = await _httpClient.GetAsync($"{_baseUrl}/api/products/portions?skip={skipRows}&count={count}");
            return new DataTable();
        }

        public async Task<int> GetTotalProductsCountAsync()
        {
            var response = await _httpClient.GetAsync($"{_baseUrl}/api/products/count");
            return 0;
        }

        public async Task<DataTable> GetUserOrderHistoryAsync()
        {
            var response = await _httpClient.GetAsync($"{_baseUrl}/api/orders/history");
            return new DataTable();
        }
    }
}

#nullable enable
using ViewModel.Models;

namespace ViewModel.Services.Classes;
public class CurrentUser
{
    public static CurrentUser Instance { get; } = new();
    public LoginResponse? User { get; private set; }

    public void SetUser(LoginResponse user)
    {
        User = user;
    }

    public void Clear()
    {
        User = null;
    }
}

#nullable enable
using Microsoft.Extensions.DependencyInjection;
using System.Windows.Controls;
using ViewModel.Core;
using ViewModel.ModalWindowsViewModel;
using ViewModel.PagesViewModel;
using ViewModel.Services.Interfaces;

namespace ViewModel.Services.Classes;

public class NavigateService : INavigateService
{
    private readonly IServiceProvider _provider;
    private Frame? _frame;

    public NavigateService(IServiceProvider provider)
    {
        _provider = provider;
    }

    public event Action<string>? Navigated;

    public void ConfigureNavigation(Frame mainFrame)
    {
        _frame = mainFrame;
    }

    public void NavigateTo<T>() where T : BasePageViewModel
    {
        var viewModel = _provider.GetRequiredService<T>();

        string pageName = viewModel switch
        {
            LoginPageViewModel => "LoginPageView",
            RegistrationPageViewModel => "RegistrationPageView",
            AdminPageViewModel => "AdminPageView",
            UserPageViewModel => "UserPageView",
            RegistrationWindowViewModel => "RegistrationWindowViewModel",
            _ => throw new ArgumentException($"Неизвестная ViewModel: {typeof(T).Name}")
        };

        Navigated?.Invoke(pageName);
    }
}

#nullable enable
namespace ViewModel.Services.Interfaces
{
    public interface IClosable
    {
        event Action? RequestClose;
    }
}

public interface IDialogService
{
    void ShowModal(object viewModel);
}

using System.Windows.Controls;
using ViewModel.Core;

namespace ViewModel.Services.Interfaces;

public interface INavigateService
{
    void NavigateTo<T>() where T : BasePageViewModel;
    void ConfigureNavigation(Frame mainFrame);
    event Action<string> Navigated;
}