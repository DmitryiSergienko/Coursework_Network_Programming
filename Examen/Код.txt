using DataLayer.Models;
using DataLayer.Procedures;
using Microsoft.Data.SqlClient;
using Microsoft.EntityFrameworkCore;
using Model;
using System.Data;

namespace DataLayer.Services
{
    public class Service
    {
        public HumansModel? CurrentHuman => _currentHuman;
        public HumansModel? DeleteHuman
        {
            get => _deleteHuman;
            set => _deleteHuman = value;
        }
        private HumansModel? _currentHuman;
        private HumansModel? _deleteHuman;

        private readonly Models.DataBaseContext _context_Models;
        private readonly Procedures.DataBaseContext _context_Procedures;
        private readonly Views.DataBaseContext _context_Views;

        public Service(
            Models.DataBaseContext contextModels,
            Procedures.DataBaseContext contextProcedures,
            Views.DataBaseContext contextViews)
        {
            _context_Models = contextModels;
            _context_Procedures = contextProcedures;
            _context_Views = contextViews;
        }

        public async Task<int> AddHumanAsync(HumansModel human)
        {
            var humanIdParam = new Procedures.OutputParameter<int?>();

            try
            {
                if (human is UsersModel)
                    await _context_Procedures.Procedures.add_user_return_idAsync(
                        login: human.Login,
                        password: human.Password,
                        name: human.Name,
                        surname: human.Surname,
                        patronymic: human.Patronymic,
                        mail: human.Mail,
                        phone_number: human.PhoneNumber,
                        userID: humanIdParam
                );
                else if (human is AdminsModel)
                {
                    await _context_Procedures.Procedures.add_admin_return_idAsync(
                        login: human.Login,
                        password: human.Password,
                        name: human.Name,
                        surname: human.Surname,
                        patronymic: human.Patronymic,
                        mail: human.Mail,
                        phone_number: human.PhoneNumber,
                        adminID: humanIdParam
                    );
                }
            }
            catch (SqlException ex)
            {
                throw MapToUserFriendlyError(ex);
            }
            if (humanIdParam.Value <= 0)
            {
                throw new Exception("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å ID.");
            }
            if(humanIdParam.Value == null)
            {
                return 0;
            }
            return humanIdParam.Value.Value;
        }

        private static Exception MapToUserFriendlyError(SqlException ex)
        {
            return ex.Message switch
            {
                string msg when msg.Contains("CHECK", StringComparison.OrdinalIgnoreCase)
                          && msg.Contains("password", StringComparison.OrdinalIgnoreCase)
                    => new ArgumentException("–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ –º–µ–Ω–µ–µ 8 —Å–∏–º–≤–æ–ª–æ–≤."),

                string msg when msg.Contains("UNIQUE", StringComparison.OrdinalIgnoreCase)
                          && msg.Contains("login", StringComparison.OrdinalIgnoreCase)
                    => new ArgumentException("–õ–æ–≥–∏–Ω —É–∂–µ –∑–∞–Ω—è—Ç."),

                string msg when msg.Contains("UNIQUE", StringComparison.OrdinalIgnoreCase)
                          && msg.Contains("mail", StringComparison.OrdinalIgnoreCase)
                    => new ArgumentException("Email —É–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è."),

                string msg when msg.Contains("NULL", StringComparison.OrdinalIgnoreCase)
                          && (msg.Contains("login") || msg.Contains("mail"))
                    => new ArgumentException("–õ–æ–≥–∏–Ω –∏ email –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã."),

                _ => new Exception($"–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {ex.Message}")
            };
        }
        public async Task<bool> OnLoginAsync(HumansModel human)
        {
            if (human == null)
            {
                return false;
            }
            try
            {
                IEnumerable<dynamic>? result = null;

                if (human is AdminsModel)
                {
                    result = await _context_Procedures.Procedures.stp_search_admin_for_authAsync(human.Login, human.Password);
                }                       
                else if (human is UsersModel)
                {
                    result = await _context_Procedures.Procedures.stp_search_user_for_authAsync(human.Login, human.Password);
                }

                if (result?.Any() == true)
                {
                    await GetHumanInfoAsync(human);
                    return true;
                }
                return false;
            }
            catch (SqlException ex)
            {
                Console.WriteLine("–û—à–∏–±–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö: " + ex.Message);
                return false;
            }
            catch (Exception ex)
            {
                // –õ—é–±–∞—è –¥—Ä—É–≥–∞—è –æ—à–∏–±–∫–∞
                Console.WriteLine("–û—à–∏–±–∫–∞: " + ex.Message);
                return false;
            }
        }
        public async Task<HumansModel?> GetHumanInfoById(int Id, string humanType)
        {
            _deleteHuman = null;

            if (humanType == "user")
            {
                var result = await _context_Procedures.Procedures.stp_search_user_by_idAsync(Id);
                var dbUser = result.FirstOrDefault();

                if (dbUser == null)
                {
                    return null;
                }

                _deleteHuman = new UsersModel(
                    login: dbUser.login,
                    password: dbUser.password,
                    name: dbUser.name,
                    surname: dbUser.surname,
                    patronymic: dbUser.patronymic,
                    mail: dbUser.mail,
                    phone_number: dbUser.phone_number
                );
            }
            else if (humanType == "admin")
            {
                var result = await _context_Procedures.Procedures.stp_search_admin_by_idAsync(Id);
                var dbAdmin = result.FirstOrDefault();

                if (dbAdmin == null)
                {
                    return null;
                }

                _deleteHuman = new AdminsModel(
                    login: dbAdmin.login,
                    password: dbAdmin.password,
                    name: dbAdmin.name,
                    surname: dbAdmin.surname,
                    patronymic: dbAdmin.patronymic,
                    mail: dbAdmin.mail,
                    phone_number: dbAdmin.phone_number
                );
            }
            return _deleteHuman;
        }
        private async Task GetHumanInfoAsync(HumansModel human)
        {
            if (human is AdminsModel admin)
            {
                var result = await _context_Procedures.Procedures.stp_search_admin_for_infoAsync(human.Login);
                var dbAdmin = result.FirstOrDefault();
                if (dbAdmin != null)
                {
                    _currentHuman = new AdminsModel(
                        login: dbAdmin.login,
                        password: dbAdmin.password,
                        name: dbAdmin.name,
                        surname: dbAdmin.surname,
                        patronymic: dbAdmin.patronymic,
                        mail: dbAdmin.mail,
                        phone_number: dbAdmin.phone_number
                    );
                }
            }
            else if (human is UsersModel user)
            {
                var result = await _context_Procedures.Procedures.stp_search_user_for_infoAsync(human.Login);
                var dbUser = result.FirstOrDefault();
                if (dbUser != null)
                {
                    _currentHuman = new UsersModel(
                        login: dbUser.login,
                        password: dbUser.password,
                        name: dbUser.name,
                        surname: dbUser.surname,
                        patronymic: dbUser.patronymic,
                        mail: dbUser.mail,
                        phone_number: dbUser.phone_number
                    );
                }
            }
        }
        public void LogOut()
        {
            _currentHuman = null;
        }
        public async Task<DataTable> ExecuteStoredProcedureAsync(string procedureName, params (string Name, object Value)[] parameters)
        {
            var dataTable = new DataTable();

            using var connection = _context_Procedures.Database.GetDbConnection();

            // –ü—Ä–æ–≤–µ—Ä–∫–∞: –µ—Å–ª–∏ ConnectionString –Ω–µ –∑–∞–¥–∞–Ω ‚Äî –æ—à–∏–±–∫–∞
            if (string.IsNullOrEmpty(connection.ConnectionString))
            {
                throw new InvalidOperationException("ConnectionString has not been initialized.");
            }

            using var command = connection.CreateCommand();
            command.CommandText = procedureName;
            command.CommandType = CommandType.StoredProcedure;

            foreach (var (Name, Value) in parameters)
            {
                var param = command.CreateParameter();
                param.ParameterName = Name.StartsWith("@") ? Name : "@" + Name;
                param.Value = Value ?? DBNull.Value;
                command.Parameters.Add(param);
            }

            if (connection.State != ConnectionState.Open)
                await connection.OpenAsync();

            using var reader = await command.ExecuteReaderAsync();
            dataTable.Load(reader);

            return dataTable;
        }
        private DataTable ConvertToDataTable<T>(IEnumerable<T> data)
        {
            var dataTable = new DataTable();
            var type = typeof(T);
            var props = type.GetProperties();

            foreach (var prop in props)
            {
                var propType = Nullable.GetUnderlyingType(prop.PropertyType) ?? prop.PropertyType;
                dataTable.Columns.Add(prop.Name, propType);
            }

            foreach (var item in data)
            {
                var row = dataTable.NewRow();
                foreach (var prop in props)
                {
                    var value = prop.GetValue(item);
                    row[prop.Name] = value ?? DBNull.Value;
                }
                dataTable.Rows.Add(row);
            }

            return dataTable;
        }
        public async Task<DataTable> GetViewDataAsync<T>(IQueryable<T> query)
        {
            var dataTable = new DataTable();

            var data = await query.ToListAsync();

            if (!data.Any()) return dataTable;

            var type = typeof(T);
            var props = type.GetProperties();

            foreach (var prop in props)
            {
                dataTable.Columns.Add(prop.Name, Nullable.GetUnderlyingType(prop.PropertyType) ?? prop.PropertyType);
            }

            foreach (var item in data)
            {
                var row = dataTable.NewRow();
                foreach (var prop in props)
                {
                    var value = prop.GetValue(item);
                    row[prop.Name] = value ?? DBNull.Value;
                }
                dataTable.Rows.Add(row);
            }

            return dataTable;
        }
        public async Task<DataTable> GetTop3ProductsAsync()
        {
            return await ExecuteSqlQueryAsync("SELECT * FROM show_top_3_products");
        }
        public async Task<DataTable> GetShowProductsInPortionsAsync(int skipRows, int showRows)
        {
            // –í—ã–∑—ã–≤–∞–µ–º –ø—Ä–æ—Ü–µ–¥—É—Ä—É ‚Äî –æ–Ω–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç List<T>
            var resultList = await _context_Procedures.Procedures.show_products_in_portionsAsync(
                skip_rows: skipRows,
                show_rows: showRows
            );

            // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º List<T> –≤ DataTable ‚Äî –±–µ–∑ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
            return ConvertToDataTable(resultList);
        }
        public async Task<DataTable> GetAllProducts()
        {
            // –í—ã–∑—ã–≤–∞–µ–º –ø—Ä–æ—Ü–µ–¥—É—Ä—É ‚Äî –æ–Ω–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç List<T>
            var resultList = await _context_Procedures.Procedures.show_all_productsAsync();

            // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º List<T> –≤ DataTable ‚Äî –±–µ–∑ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
            return ConvertToDataTable(resultList);
        }
        public async Task<List<show_all_productsResult>> GetListAllProductsAsync()
        {
            return await _context_Procedures.Procedures.show_all_productsAsync();
        }
        public async Task<DataTable> GetUserOrderHistoryAsync() //–ü–æ–¥—É–º–∞—Ç—å
        {
            return await ExecuteSqlQueryAsync("SELECT * FROM show_number_of_users_orders");
        }
        public async Task<DataTable> GetUsersWithoutPasswordAsync() //–ü–æ–¥—É–º–∞—Ç—å
        {
            return await GetViewDataAsync(_context_Views.show_users_without_passwords);
        }
        public async Task AssignImageToAdmin(int adminId, int imageId)
        {
            try
            {
                // ‚úÖ –°–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ –≤—ã–∑–æ–≤—ã ‚Äî —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –æ—à–∏–±–∫–∏ —Å IQueryable
                var admin = _context_Models.adminsSets.FirstOrDefault(a => a.id == adminId);
                if (admin == null)
                {
                    Console.WriteLine($"‚ùå –ê–¥–º–∏–Ω —Å ID {adminId} –Ω–µ –Ω–∞–π–¥–µ–Ω!");
                    throw new ArgumentException($"–ê–¥–º–∏–Ω —Å ID {adminId} –Ω–µ –Ω–∞–π–¥–µ–Ω.");
                }

                var image = _context_Models.imagesSets.FirstOrDefault(i => i.id == imageId);
                if (image == null)
                {
                    Console.WriteLine($"‚ùå –ö–∞—Ä—Ç–∏–Ω–∫–∞ —Å ID {imageId} –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!");
                    throw new ArgumentException($"–ö–∞—Ä—Ç–∏–Ω–∫–∞ —Å ID {imageId} –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.");
                }

                admin.images_id = imageId;
                await _context_Models.SaveChangesAsync();
                Console.WriteLine($"‚úÖ –£—Å–ø–µ—à–Ω–æ –ø—Ä–∏–≤—è–∑–∞–ª–∏ –∫–∞—Ä—Ç–∏–Ω–∫—É ID {imageId} –∫ –∞–¥–º–∏–Ω—É ID {adminId}");
            }
            catch (Exception ex)
            {
                Console.WriteLine($"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–∏–≤—è–∑–∫–µ –∫–∞—Ä—Ç–∏–Ω–∫–∏ –∫ –∞–¥–º–∏–Ω—É ID {adminId}: {ex.Message}");
                throw;
            }
        }
        public async Task AssignImageToUser(int userId, int imageId)
        {
            try
            {
                // ‚úÖ –°–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ –≤—ã–∑–æ–≤—ã ‚Äî —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –æ—à–∏–±–∫–∏ —Å IQueryable
                var user = _context_Models.usersSets.FirstOrDefault(u => u.id == userId);
                if (user == null)
                {
                    Console.WriteLine($"‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å ID {userId} –Ω–µ –Ω–∞–π–¥–µ–Ω!");
                    throw new ArgumentException($"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å ID {userId} –Ω–µ –Ω–∞–π–¥–µ–Ω.");
                }

                var image = _context_Models.imagesSets.FirstOrDefault(i => i.id == imageId);
                if (image == null)
                {
                    Console.WriteLine($"‚ùå –ö–∞—Ä—Ç–∏–Ω–∫–∞ —Å ID {imageId} –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!");
                    throw new ArgumentException($"–ö–∞—Ä—Ç–∏–Ω–∫–∞ —Å ID {imageId} –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.");
                }

                user.images_id = imageId;
                await _context_Models.SaveChangesAsync();
                Console.WriteLine($"‚úÖ –£—Å–ø–µ—à–Ω–æ –ø—Ä–∏–≤—è–∑–∞–ª–∏ –∫–∞—Ä—Ç–∏–Ω–∫—É ID {imageId} –∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é ID {userId}");
            }
            catch (Exception ex)
            {
                Console.WriteLine($"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–∏–≤—è–∑–∫–µ –∫–∞—Ä—Ç–∏–Ω–∫–∏ –∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é ID {userId}: {ex.Message}");
                throw;
            }
        }
        public async Task AssignImageToProduct(int productId, int imageId)
        {
            try
            {
                // ‚úÖ –°–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ –≤—ã–∑–æ–≤—ã ‚Äî —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –æ—à–∏–±–∫–∏ —Å IQueryable
                var product = _context_Models.productsSets.FirstOrDefault(p => p.id == productId);
                if (product == null)
                {
                    Console.WriteLine($"‚ùå –ü—Ä–æ–¥—É–∫—Ç —Å ID {productId} –Ω–µ –Ω–∞–π–¥–µ–Ω!");
                    throw new ArgumentException($"–ü—Ä–æ–¥—É–∫—Ç —Å ID {productId} –Ω–µ –Ω–∞–π–¥–µ–Ω.");
                }

                var image = _context_Models.imagesSets.FirstOrDefault(i => i.id == imageId);
                if (image == null)
                {
                    Console.WriteLine($"‚ùå –ö–∞—Ä—Ç–∏–Ω–∫–∞ —Å ID {imageId} –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!");
                    throw new ArgumentException($"–ö–∞—Ä—Ç–∏–Ω–∫–∞ —Å ID {imageId} –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.");
                }

                product.images_id = imageId;
                await _context_Models.SaveChangesAsync();
                Console.WriteLine($"‚úÖ –£—Å–ø–µ—à–Ω–æ –ø—Ä–∏–≤—è–∑–∞–ª–∏ –∫–∞—Ä—Ç–∏–Ω–∫—É ID {imageId} –∫ –ø—Ä–æ–¥—É–∫—Ç—É ID {productId}");
            }
            catch (Exception ex)
            {
                Console.WriteLine($"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–∏–≤—è–∑–∫–µ –∫–∞—Ä—Ç–∏–Ω–∫–∏ –∫ –ø—Ä–æ–¥—É–∫—Ç—É ID {productId}: {ex.Message}");
                throw;
            }
        }
        public async Task<int> AddImageAsync(string fileName, string filePath)
        {
            if (!File.Exists(filePath))
                throw new FileNotFoundException($"–§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω: {filePath}");

            byte[] imageData = await File.ReadAllBytesAsync(filePath);

            var image = new imagesSet
            {
                name = fileName,
                image = imageData
            };

            _context_Models.imagesSets.Add(image);
            await _context_Models.SaveChangesAsync();

            return image.id;
        }
        public async Task<Dictionary<string, int>> BulkAddImagesFromFolderAsync(string folderPath)
        {
            var result = new Dictionary<string, int>();

            if (!Directory.Exists(folderPath))
                throw new DirectoryNotFoundException($"–ü–∞–ø–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞: {folderPath}");

            var files = Directory.GetFiles(folderPath, "*.*")
                .Where(f => f.EndsWith(".jpg") || f.EndsWith(".png") || f.EndsWith(".jpeg"));

            foreach (var filePath in files)
            {
                string fileName = Path.GetFileName(filePath);
                int imageId = await AddImageAsync(fileName, filePath);
                result[fileName] = imageId;
            }

            return result;
        }
        public async Task AddPicturesToAllTablesAsync()
        {
            try
            {
                Console.WriteLine("üöÄ [AddPicturesToAllTablesAsync] –ù–∞—á–∏–Ω–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ...");

                // 1. –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø—É—Ç—å –∫ –ø–∞–ø–∫–µ Resources
                string resourcesPath = Path.Combine(AppDomain.CurrentDomain.BaseDirectory, "Resources");

                // ‚úÖ –õ–û–ì–ò–†–£–ï–ú –ü–£–¢–¨ –ò –ü–†–û–í–ï–†–Ø–ï–ú –°–£–©–ï–°–¢–í–û–í–ê–ù–ò–ï –ü–ê–ü–ö–ò
                Console.WriteLine($"üîç –ü—É—Ç—å –∫ –ø–∞–ø–∫–µ —Å –∫–∞—Ä—Ç–∏–Ω–∫–∞–º–∏: {resourcesPath}");
                if (!Directory.Exists(resourcesPath))
                {
                    Console.WriteLine($"‚ùå –ü–∞–ø–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞: {resourcesPath}");
                    throw new DirectoryNotFoundException($"–ü–∞–ø–∫–∞ —Å –∫–∞—Ä—Ç–∏–Ω–∫–∞–º–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞: {resourcesPath}");
                }

                // –ò—â–µ–º —Ñ–∞–π–ª—ã
                var files = Directory.GetFiles(resourcesPath, "*.*")
                    .Where(f => f.EndsWith(".jpg", StringComparison.OrdinalIgnoreCase) ||
                                f.EndsWith(".png", StringComparison.OrdinalIgnoreCase) ||
                                f.EndsWith(".jpeg", StringComparison.OrdinalIgnoreCase))
                    .ToList();

                Console.WriteLine($"üìÇ –ù–∞–π–¥–µ–Ω–æ —Ñ–∞–π–ª–æ–≤: {files.Count}");
                foreach (var file in files)
                {
                    Console.WriteLine($"üìÑ {Path.GetFileName(file)}");
                }

                if (files.Count == 0)
                {
                    Console.WriteLine("‚ö†Ô∏è –í –ø–∞–ø–∫–µ –Ω–µ—Ç –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö —Ñ–∞–π–ª–æ–≤ (.jpg, .png, .jpeg)");
                    return;
                }

                // 2. –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–∞—Ä—Ç–∏–Ω–∫–∏ –≤ –ë–î
                Console.WriteLine("‚è≥ –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–∞—Ä—Ç–∏–Ω–∫–∏ –≤ imagesSets...");
                var imageMap = await BulkAddImagesFromFolderAsync(resourcesPath);
                Console.WriteLine($"‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ –≤ imagesSet: {imageMap.Count} –∫–∞—Ä—Ç–∏–Ω–æ–∫");

                if (imageMap.Count == 0)
                {
                    Console.WriteLine("‚ö†Ô∏è –ù–∏ –æ–¥–Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∫–∞ –Ω–µ –±—ã–ª–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞ –≤ –ë–î");
                    return;
                }

                // 3. –ü—Ä–∏–≤—è–∑—ã–≤–∞–µ–º –∫ –∞–¥–º–∏–Ω–∞–º
                Console.WriteLine("üë• –ó–∞–≥—Ä—É–∂–∞–µ–º –∞–¥–º–∏–Ω–æ–≤...");
                var admins = _context_Models.adminsSets.ToList(); // ‚Üê –°–∏–Ω—Ö—Ä–æ–Ω–Ω–æ, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –æ—à–∏–±–∫–∏
                Console.WriteLine($"‚úÖ –ù–∞–π–¥–µ–Ω–æ –∞–¥–º–∏–Ω–æ–≤: {admins.Count}");

                foreach (var admin in admins)
                {
                    var matchedFile = imageMap.Keys
                        .FirstOrDefault(k => Path.GetFileNameWithoutExtension(k)
                            .Equals(admin.login, StringComparison.OrdinalIgnoreCase));

                    if (!string.IsNullOrEmpty(matchedFile))
                    {
                        int imageId = imageMap[matchedFile];
                        Console.WriteLine($"‚úÖ –ü—Ä–∏—Å–≤–∞–∏–≤–∞–µ–º –∫–∞—Ä—Ç–∏–Ω–∫—É '{matchedFile}' –∞–¥–º–∏–Ω—É '{admin.login}' (ID: {admin.id})");
                        await AssignImageToAdmin(admin.id, imageId);
                        Console.WriteLine($"‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –¥–ª—è –∞–¥–º–∏–Ω–∞ ID {admin.id}");
                    }
                    else
                    {
                        Console.WriteLine($"‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∫–∞ –¥–ª—è –∞–¥–º–∏–Ω–∞: {admin.login}");
                    }
                }

                // 4. –ü—Ä–∏–≤—è–∑—ã–≤–∞–µ–º –∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º
                Console.WriteLine("üë• –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π...");
                var users = _context_Models.usersSets.ToList(); // ‚Üê –°–∏–Ω—Ö—Ä–æ–Ω–Ω–æ
                Console.WriteLine($"‚úÖ –ù–∞–π–¥–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: {users.Count}");

                foreach (var user in users)
                {
                    var matchedFile = imageMap.Keys
                        .FirstOrDefault(k => Path.GetFileNameWithoutExtension(k)
                            .Equals(user.login, StringComparison.OrdinalIgnoreCase));

                    if (!string.IsNullOrEmpty(matchedFile))
                    {
                        int imageId = imageMap[matchedFile];
                        Console.WriteLine($"‚úÖ –ü—Ä–∏—Å–≤–∞–∏–≤–∞–µ–º –∫–∞—Ä—Ç–∏–Ω–∫—É '{matchedFile}' –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é '{user.login}' (ID: {user.id})");
                        await AssignImageToUser(user.id, imageId);
                        Console.WriteLine($"‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ID {user.id}");
                    }
                    else
                    {
                        Console.WriteLine($"‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∫–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {user.login}");
                    }
                }

                // 5. –ü—Ä–∏–≤—è–∑—ã–≤–∞–µ–º –∫ –ø—Ä–æ–¥—É–∫—Ç–∞–º
                Console.WriteLine("üì¶ –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–æ–¥—É–∫—Ç—ã...");
                var products = _context_Models.productsSets.ToList(); // ‚Üê –°–∏–Ω—Ö—Ä–æ–Ω–Ω–æ
                Console.WriteLine($"‚úÖ –ù–∞–π–¥–µ–Ω–æ –ø—Ä–æ–¥—É–∫—Ç–æ–≤: {products.Count}");

                foreach (var product in products)
                {
                    var matchedFile = imageMap.Keys
                        .FirstOrDefault(k => Path.GetFileNameWithoutExtension(k)
                            .Equals(product.name, StringComparison.OrdinalIgnoreCase));

                    if (!string.IsNullOrEmpty(matchedFile))
                    {
                        int imageId = imageMap[matchedFile];
                        Console.WriteLine($"‚úÖ –ü—Ä–∏—Å–≤–∞–∏–≤–∞–µ–º –∫–∞—Ä—Ç–∏–Ω–∫—É '{matchedFile}' –ø—Ä–æ–¥—É–∫—Ç—É '{product.name}' (ID: {product.id})");
                        await AssignImageToProduct(product.id, imageId);
                        Console.WriteLine($"‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –¥–ª—è –ø—Ä–æ–¥—É–∫—Ç–∞ ID {product.id}");
                    }
                    else
                    {
                        Console.WriteLine($"‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∫–∞ –¥–ª—è –ø—Ä–æ–¥—É–∫—Ç–∞: {product.name}");
                    }
                }

                Console.WriteLine("üéâ [AddPicturesToAllTablesAsync] –ü—Ä–∏–≤—è–∑–∫–∞ –∫–∞—Ä—Ç–∏–Ω–æ–∫ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!");
            }
            catch (Exception ex)
            {
                Console.WriteLine($"‚ùå –û–®–ò–ë–ö–ê –≤ AddPicturesToAllTablesAsync: {ex.Message}");
                Console.WriteLine($"üìù –°—Ç–µ–∫: {ex.StackTrace}");
                throw;
            }
        }
        public async Task<DataTable> ExecuteSqlQueryAsync(string sqlQuery)
        {
            var dataTable = new DataTable();
            using var connection = _context_Procedures.Database.GetDbConnection();
            using var command = connection.CreateCommand();
            command.CommandText = sqlQuery;
            command.CommandType = CommandType.Text;
            if (connection.State != ConnectionState.Open)
                await connection.OpenAsync();
            using var reader = await command.ExecuteReaderAsync();
            dataTable.Load(reader);
            return dataTable;
        }
    }
}

namespace DataLayer
{
    public static class DataBaseContext_General
    {
        public static Models.DataBaseContext base_TZ_21_07_2025Context(this Models.DataBaseContext context) 
        {
            return context;
        }
        public static Procedures.DataBaseContext base_TZ_21_07_2025Context(this Procedures.DataBaseContext context) 
        {
            return context;
        }
        public static Views.DataBaseContext base_TZ_21_07_2025Context(this Views.DataBaseContext context)
        {
            return context;
        }
    }
}

using System.ComponentModel.DataAnnotations.Schema;
using static System.Net.Mime.MediaTypeNames;

namespace Model
{
    abstract public class HumansModel
    {
        public HumansModel(int id, string login, string password, string name, string surname, string patronymic, string mail, string phone_number, DateTime? registration_date, int images_id)
        {
            Id = id;
            Login = login;
            Password = password;
            Name = name;
            Surname = surname;
            Patronymic = patronymic;
            Mail = mail;
            PhoneNumber = phone_number;
            Registration_date = registration_date;
            Images_id = images_id;
        }
        public HumansModel(string login, string password, string name, string surname, string patronymic, string mail, string phone_number, int images_id)
        {
            Login = login;
            Password = password;
            Name = name;
            Surname = surname;
            Patronymic = patronymic;
            Mail = mail;
            PhoneNumber = phone_number;
            Images_id = images_id;
        }
        public HumansModel(string login, string password, string name, string surname, string patronymic, string mail, string phone_number)
        {
            Login = login;
            Password = password;
            Name = name;
            Surname = surname;
            Patronymic = patronymic;
            Mail = mail;
            PhoneNumber = phone_number;
        }
        public HumansModel(string login, string password)
        {
            Login = login;
            Password = password;
        }
        public int Id { get; set; }
        public string Login { get; set; }
        public string Password { get; set; }
        public string Name { get; set; }
        public string Surname { get; set; }
        public string Patronymic { get; set; }
        public string Mail { get; set; }
        public string PhoneNumber { get; set; }
        public Nullable<System.DateTime> Registration_date { get; set; }
        public int? Images_id { get; set; }
        public virtual ImagesModel Image { get; set; }
        public override string ToString()
        {
            return $"{Id,5} {Login,15} {Name,15} {Surname,15} {Mail,20} {Convert.ToDateTime(Registration_date),20}";
        }
    }
}

using static System.Net.Mime.MediaTypeNames;

namespace Model
{
    public class AdminsModel : HumansModel
    {
        public AdminsModel(int id, string login, string password, string name, string surname, string patronymic, string mail, string phone_number, DateTime? registration_date, int images_id)
            : base(id, login, password, name, surname, patronymic, mail, phone_number, registration_date, images_id) { }
        public AdminsModel(string login, string password, string name, string surname, string patronymic, string mail, string phone_number, int images_id)
            : base(login, password, name, surname, patronymic, mail, phone_number, images_id) { }
        public AdminsModel(string login, string password, string name, string surname, string patronymic, string mail, string phone_number)
            : base(login, password, name, surname, patronymic, mail, phone_number) { }
        public AdminsModel(string login, string password)
            : base(login, password) { }
    }
}

namespace Model
{
    public class ImagesModel
    {
        public int Id { get; set; }
        public required string Name { get; set; }
        public required byte[] ImageData { get; set; }
    }
}

namespace Model
{
    public class UsersModel : HumansModel
    {
        public UsersModel(int id, string login, string password, string name, string surname, string patronymic, string mail, string phone_number, DateTime? registration_date, int images_id)
            : base(id, login, password, name, surname, patronymic, mail, phone_number, registration_date, images_id) { }
        public UsersModel(string login, string password, string name, string surname, string patronymic, string mail, string phone_number, int images_id)
            : base(login, password, name, surname, patronymic, mail, phone_number, images_id) { }
        public UsersModel(string login, string password, string name, string surname, string patronymic, string mail, string phone_number)
            : base(login, password, name, surname, patronymic, mail, phone_number) { }
        public UsersModel(string login, string password)
            : base(login, password) { }
    }
}

using System.Windows.Input;

namespace ViewModel.Core
{
    public class AsyncRelayCommand : ICommand
    {
        private readonly Func<Task> _execute;
        private readonly Func<bool> _canExecute;

        public event EventHandler CanExecuteChanged
        {
            add => CommandManager.RequerySuggested += value;
            remove => CommandManager.RequerySuggested -= value;
        }

        public AsyncRelayCommand(Func<Task> execute, Func<bool> canExecute = null)
        {
            _execute = execute ?? throw new ArgumentNullException(nameof(execute));
            _canExecute = canExecute;
        }

        public bool CanExecute(object parameter) => _canExecute?.Invoke() ?? true;

        public async void Execute(object parameter)
        {
            if (CanExecute(parameter))
            {
                await _execute();
            }
        }
    }
}

using System.Runtime.CompilerServices;

namespace ViewModel.Core;
public abstract class BasePageViewModel : ObservableObject
{
    protected bool Set<T>(ref T field, T value, [CallerMemberName] string propertyName = null)
    {
        if (EqualityComparer<T>.Default.Equals(field, value)) return false;
        field = value;
        OnPropertyChanged(propertyName);
        return true;
    }
}

using System.ComponentModel;
using System.Runtime.CompilerServices;

namespace ViewModel.Core;
public class ObservableObject : INotifyPropertyChanged
{
    public string? Title { get; set; }

    public event PropertyChangedEventHandler? PropertyChanged;
    public void OnPropertyChanged([CallerMemberName] string prop = "")
    {
        PropertyChanged?.Invoke(this, new PropertyChangedEventArgs(prop));
    }
}

using System.Windows.Input;

namespace ViewModel.Core;

public class RelayCommand(Action<object?> execute, Func<object?, bool>? canExecute = null) : ICommand
{
    public event EventHandler? CanExecuteChanged
    {
        add { CommandManager.RequerySuggested += value; }
        remove { CommandManager.RequerySuggested -= value; }
    }
    public bool CanExecute(object? parameter)
    {
        return canExecute == null || canExecute(parameter);
    }
    public void Execute(object? parameter)
    {
        execute(parameter);
    }
}

using DataLayer.Services;
using Model;
using System.Windows;
using System.Windows.Input;
using ViewModel.Core;
using ViewModel.Services.Interfaces;

namespace ViewModel.ModalWindowsViewModel
{
    public class DeleteHumanWindowViewModel : BasePageViewModel, IClosable
    {
        public DeleteHumanWindowViewModel() { } // –ù—É–∂–µ–Ω –¥–ª—è –¥–∏–∑–∞–π–Ω–µ—Ä–∞
        private Service _deleteHum;
        public Service DeleteHum
        {
            get => _deleteHum;
            set => _deleteHum = value;
        }
        public event Action? RequestClose;
        public ICommand SearchHuman { get; set; }
        public ICommand DeleteHuman { get; set; }

        public int Id 
        {
            get => _id;
            set
            {
                Set(ref _id, value);
                UpdateSearchButtonState();
            }
        }
        private int _id;
        public string? Login => _deleteHum?.DeleteHuman?.Login;
        public string? Name => _deleteHum?.DeleteHuman?.Name;
        public string? Surname => _deleteHum?.DeleteHuman?.Surname;
        public string? Patronymic => _deleteHum?.DeleteHuman?.Patronymic;
        public string? Email => _deleteHum?.DeleteHuman?.Mail;
        public string? Phone => _deleteHum?.DeleteHuman?.PhoneNumber;

        private string _humanType;
        public string HumanType
        {
            get => _humanType;
            set => _humanType = value;
        }

        public DeleteHumanWindowViewModel(Service humanService) 
        {
            _deleteHum = humanService;
            RequestClose += OnWindowClosed;

            SearchHuman = new RelayCommand(async obj =>
            {
                try
                {
                    HumansModel human = await humanService.GetHumanInfoById(Id, HumanType);
                    if (human != null)
                    {
                        RefreshHumanProperties();
                        UpdateDeleteButtonState();
                    }
                    else
                    {
                        MessageBox.Show("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω");
                        RefreshHumanProperties();
                        UpdateDeleteButtonState();
                    }
                }
                catch (Exception ex)
                {
                    MessageBox.Show($"–û—à–∏–±–∫–∞: {ex.Message}");
                }
            });

            DeleteHuman = new RelayCommand(async obj =>
            {
                MessageBox.Show("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–¥–∞–ª—ë–Ω");

                // –û–ß–ò–°–¢–ò–¢–¨ –î–ê–ù–ù–´–ï –ü–ï–†–ï–î –û–ë–ù–û–í–õ–ï–ù–ò–ï–ú UI!
                if (_deleteHum != null)
                {
                    _deleteHum.DeleteHuman = null; // ‚Üê –í–ê–ñ–ù–û!
                }

                RefreshHumanProperties(); // ‚Üê –¢–µ–ø–µ—Ä—å UI —É–≤–∏–¥–∏—Ç null –∏ –æ—á–∏—Å—Ç–∏—Ç –ø–æ–ª—è
                RequestClose?.Invoke();
            });
        }
        private void OnWindowClosed()
        {
            DeleteHum = null;
            RefreshHumanProperties();
        }
        private void UpdateSearchButtonState()
        {
            IsEnabledIdInput = Id > 0;
        }
        private bool _isEnabledIdInput = false;
        public bool IsEnabledIdInput
        {
            get => _isEnabledIdInput;
            set
            {
                _isEnabledIdInput = value;
                OnPropertyChanged();
            }
        }
        private void UpdateDeleteButtonState()
        {
            IsEnabledFormDelete = !string.IsNullOrWhiteSpace(Login)
                                        && !string.IsNullOrWhiteSpace(Name)
                                        && !string.IsNullOrWhiteSpace(Surname)
                                        && !string.IsNullOrWhiteSpace(Patronymic)
                                        && !string.IsNullOrWhiteSpace(Email)
                                        && !string.IsNullOrWhiteSpace(Phone);
        }
        private bool _isEnabledFormDelete = false;

        public bool IsEnabledFormDelete
        {
            get => _isEnabledFormDelete;
            set
            {
                _isEnabledFormDelete = value;
                OnPropertyChanged();
            }
        }
        private void RefreshHumanProperties()
        {
            OnPropertyChanged(nameof(Login));
            OnPropertyChanged(nameof(Name));
            OnPropertyChanged(nameof(Surname));
            OnPropertyChanged(nameof(Patronymic));
            OnPropertyChanged(nameof(Email));
            OnPropertyChanged(nameof(Phone));
        }
        public void ClearData()
        {
            if (_deleteHum != null)
            {
                _deleteHum.DeleteHuman = null;
            }
            Id = 0;
            RefreshHumanProperties();
        }
    }
}

using DataLayer.Services;
using Model;
using System.Windows;
using System.Windows.Input;
using ViewModel.Core;
using ViewModel.Services.Interfaces;

namespace ViewModel.ModalWindowsViewModel
{
    public class RegistrationWindowViewModel : BasePageViewModel, IClosable
    {
        public RegistrationWindowViewModel() { } // –ù—É–∂–µ–Ω –¥–ª—è –¥–∏–∑–∞–π–Ω–µ—Ä–∞
        private readonly Service _humanService;
        public ICommand SendFormRegistration { get; }
        public event Action? RequestClose;

        private string _login;
        private string _password;
        private string _name;
        private string _surname;
        private string _patronymic;
        private string _mail;
        private string _phoneNumber;
        public RegistrationWindowViewModel(Service humanService)
        {
            _humanService = humanService;

            SendFormRegistration = new RelayCommand(OnSendForm);
        }

        private string _humanType;
        public void GetTypeHuman(string humanType)
        {
            _humanType = humanType;
        }
        private async void OnSendForm(object? obj)
        {
            if (string.IsNullOrWhiteSpace(Login) ||
                string.IsNullOrWhiteSpace(Password) ||
                string.IsNullOrWhiteSpace(Name) ||
                string.IsNullOrWhiteSpace(Surname) ||
                string.IsNullOrWhiteSpace(Mail))
            {
                MessageBox.Show("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è.");
                return;
            }

            HumansModel human;
            if (_humanType == "user")
            {
                human = new UsersModel
                (
                    Login,
                    Password,
                    Name,
                    Surname,
                    Patronymic,
                    Mail,
                    PhoneNumber
                );
            }
            else
            {
                human = new AdminsModel
                (
                    Login,
                    Password,
                    Name,
                    Surname,
                    Patronymic,
                    Mail,
                    PhoneNumber
                );
            }                

            try
            {
                int newId = await _humanService.AddHumanAsync(human);

                if (newId > 0)
                {
                    MessageBox.Show($"–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞! ID: {newId}");
                    RequestClose?.Invoke();
                }
                else
                {
                    MessageBox.Show("–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏.");
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show("–û—à–∏–±–∫–∞: " + ex.Message);
            }
        }

        public string Login
        {
            get => _login;
            set
            {
                Set(ref _login, value);
                UpdateSendButtonState();
            }
        }
        public string Password
        {
            get => _password;
            set
            {
                Set(ref _password, value);
                UpdateSendButtonState();
            }
        }
        public string Name
        {
            get => _name;
            set
            {
                Set(ref _name, value);
                UpdateSendButtonState();
            }
        }
        public string Surname
        {
            get => _surname;
            set
            {
                Set(ref _surname, value);
                UpdateSendButtonState();
            }
        }
        public string Patronymic
        {
            get => _patronymic;
            set
            {
                Set(ref _patronymic, value);
                UpdateSendButtonState();
            }
        }
        public string Mail
        {
            get => _mail;
            set
            {
                Set(ref _mail, value);
                UpdateSendButtonState();
            }
        }
        public string PhoneNumber
        {
            get => _phoneNumber;
            set
            {
                Set(ref _phoneNumber, value);
                UpdateSendButtonState();
            }
        }
        private void UpdateSendButtonState()
        {
            IsEnabledSendFormRegistration = !string.IsNullOrWhiteSpace(Login)
                                        && !string.IsNullOrWhiteSpace(Password)
                                        && !string.IsNullOrWhiteSpace(Name)
                                        && !string.IsNullOrWhiteSpace(Surname)
                                        && !string.IsNullOrWhiteSpace(Patronymic)
                                        && !string.IsNullOrWhiteSpace(Mail)
                                        && !string.IsNullOrWhiteSpace(PhoneNumber);

        }
        private bool _isEnabledSendFormRegistration = false;

        public bool IsEnabledSendFormRegistration
        {
            get => _isEnabledSendFormRegistration;
            set
            {
                _isEnabledSendFormRegistration = value;
                OnPropertyChanged();
            }
        }
    }
}

using DataLayer.Services;
using Microsoft.Data.SqlClient;
using System.Data;
using System.IO;
using System.Windows.Input;
using System.Windows.Media.Imaging;
using ViewModel.Core;
using ViewModel.ModalWindowsViewModel;
using ViewModel.Services.Interfaces;

namespace ViewModel.PagesViewModel;
public class AdminPageViewModel : BasePageViewModel
{
    public AdminPageViewModel() { } // –ù—É–∂–µ–Ω –¥–ª—è –¥–∏–∑–∞–π–Ω–µ—Ä–∞

    private readonly INavigateService _navigateService;
    private readonly Service _service;
    private readonly IDialogService _iDialogService;
    private readonly DataLayer.Models.DataBaseContext _dbContext;
    public string? LoginAdmin => _service.CurrentHuman?.Login;
    public string? NameAdmin => _service.CurrentHuman?.Name;
    public string? SurnameAdmin => _service.CurrentHuman?.Surname;
    public string? EmailAdmin => _service.CurrentHuman?.Mail;
    public string? PhoneAdmin => _service.CurrentHuman?.PhoneNumber;
    public ICommand LogOut { get; }
    public ICommand AddUser { get; }
    public ICommand UpdateUser { get; }
    public ICommand DeleteUser { get; }
    public ICommand AddAdmin { get; }
    public ICommand UpdateAdmin { get; }
    public ICommand DeleteAdmin { get; }
    public ICommand AddProduct { get; }
    public ICommand UpdateProduct { get; }
    public ICommand DeleteProduct { get; }
    public ICommand AddCategory { get; }
    public ICommand UpdateCategory { get; }
    public ICommand DeleteCategory { get; }
    public ICommand AddQuantityProduct { get; }

    private string _inputArea;
    public string InputArea
    {
        get => _inputArea;
        set
        {
            _inputArea = value;
            OnPropertyChanged();
        }
    }
    private DataTable _dataTableAdmin;
    public DataTable DataTableAdmin
    {
        get => _dataTableAdmin;
        set
        {
            _dataTableAdmin = value;
            OnPropertyChanged();
        }
    }
    public ICommand ExecuteQueryCommand { get; }
    public AdminPageViewModel(INavigateService navigateService, IDialogService iDialogService, Service service, DataLayer.Models.DataBaseContext dbContext)
    {
        _navigateService = navigateService;
        _iDialogService = iDialogService;
        _service = service;
        _dbContext = dbContext;

        LogOut = new RelayCommand(obj =>
        {
            service.LogOut();
            navigateService.NavigateTo<LoginPageViewModel>();
        });

        ExecuteQueryCommand = new RelayCommand(ExecuteQuery);
        DataTableAdmin = new DataTable();

        AddUser = new RelayCommand(async obj =>
        {
            var vm = new RegistrationWindowViewModel(_service);
            vm.GetTypeHuman("user");                            
            _iDialogService.ShowModal(vm);                      
        });
        UpdateUser = new RelayCommand(async obj => { });
        DeleteUser = new RelayCommand(async obj => 
        {
            var vm = new DeleteHumanWindowViewModel(_service);
            vm.HumanType = "user";
            _iDialogService.ShowModal(vm);
        });
        AddAdmin = new RelayCommand(async obj =>
        {
            var vm = new RegistrationWindowViewModel(_service);
            vm.GetTypeHuman("admin");
            _iDialogService.ShowModal(vm);
        });
        UpdateAdmin = new RelayCommand(async obj => { });
        DeleteAdmin = new RelayCommand(async obj => 
        {
            var vm = new DeleteHumanWindowViewModel(_service);
            vm.HumanType = "admin";
            _iDialogService.ShowModal(vm);
        });
        AddProduct = new RelayCommand(async obj => { });
        UpdateProduct = new RelayCommand(async obj => { });
        DeleteProduct = new RelayCommand(async obj => { });
        AddCategory = new RelayCommand(async obj => { });
        UpdateCategory = new RelayCommand(async obj => { });
        DeleteCategory = new RelayCommand(async obj => { });
        AddQuantityProduct = new RelayCommand(async obj => { });
    }
    private async void ExecuteQuery(object parameter)
    {
        try
        {
            string connectionString = "Server=(localdb)\\MSSQLLocalDB;Database=Examen_ModelFirst;User Id=user1;Password=sa;TrustServerCertificate=True;";
            using (var connection = new SqlConnection(connectionString))
            {
                connection.Open();
                using (var command = new SqlCommand(InputArea, connection))
                using (var adapter = new SqlDataAdapter(command))
                {
                    var resultTable = new DataTable();
                    adapter.Fill(resultTable);

                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –≤ —Ç–∞–±–ª–∏—Ü–µ —Å—Ç–æ–ª–±–µ—Ü "images_id"
                    if (resultTable.Columns.Contains("images_id"))
                    {
                        // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π —Å—Ç–æ–ª–±–µ—Ü –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
                        resultTable.Columns.Add("Image", typeof(byte[]));

                        // –ü—Ä–æ—Ö–æ–¥–∏–º –ø–æ –∫–∞–∂–¥–æ–π —Å—Ç—Ä–æ–∫–µ –∏ –∑–∞–ø–æ–ª–Ω—è–µ–º —Å—Ç–æ–ª–±–µ—Ü "Image"
                        foreach (DataRow row in resultTable.Rows)
                        {
                            if (row["images_id"] != DBNull.Value && int.TryParse(row["images_id"].ToString(), out int imageId))
                            {
                                // –ò—Å–ø–æ–ª—å–∑—É–µ–º _dbContext –¥–ª—è –ø–æ–∏—Å–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
                                var imageEntity = await _dbContext.imagesSets.FindAsync(imageId);
                                row["Image"] = imageEntity?.image; // –ü—Ä–∏—Å–≤–∞–∏–≤–∞–µ–º –º–∞—Å—Å–∏–≤ –±–∞–π—Ç –∏–ª–∏ null
                            }
                        }

                        // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π —Å—Ç–æ–ª–±–µ—Ü "images_id", —á—Ç–æ–±—ã –æ–Ω –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞–ª—Å—è
                        resultTable.Columns.Remove("images_id");
                    }

                    DataTableAdmin = resultTable;
                }
            }
        }
        catch (Exception ex)
        {
            var errorTable = new DataTable();
            errorTable.Columns.Add("–û—à–∏–±–∫–∞", typeof(string));
            errorTable.Rows.Add(ex.Message);
            DataTableAdmin = errorTable;
        }
    }

    private byte[] _imageData;
    public byte[] ImageData
    {
        get => _imageData;
        set
        {
            if (Set(ref _imageData, value))
            {
                OnPropertyChanged(nameof(Image));
            }
        }
    }
    public BitmapImage Image
    {
        get
        {
            if (_imageData == null || _imageData.Length == 0)
                return null;

            try
            {
                var image = new BitmapImage();
                using (var stream = new MemoryStream(_imageData))
                {
                    image.BeginInit();
                    image.StreamSource = stream;
                    image.CacheOption = BitmapCacheOption.OnLoad;
                    image.EndInit();
                    image.Freeze();
                }
                return image;
            }
            catch
            {
                return null;
            }
        }
    }
}

using DataLayer.Services;
using Model;
using System.Windows;
using System.Windows.Input;
using ViewModel.Core;
using ViewModel.Services.Interfaces;

namespace ViewModel.PagesViewModel;
public class LoginPageViewModel : BasePageViewModel
{
    public LoginPageViewModel() { } // –ù—É–∂–µ–Ω –¥–ª—è –¥–∏–∑–∞–π–Ω–µ—Ä–∞
    private readonly INavigateService _navigateService;
    private readonly Service _userService;
    public ICommand NavigateToSignIn { get; }
    public ICommand NavigateToRegistration { get; }
    public LoginPageViewModel(INavigateService navigateService, Service userService)
    {
        _navigateService = navigateService;
        _userService = userService;

        NavigateToSignIn = new RelayCommand(OnLoginAsync);
        NavigateToRegistration = new RelayCommand(obj => navigateService.NavigateTo<RegistrationPageViewModel>());
    }
    private string _login;
    private string _password;
    public string Login
    {
        get => _login;
        set
        {
            Set(ref _login, value);
            UpdateSignInButtonState();
        }
    }
    public string Password
    {
        get => _password;
        set
        {
            Set(ref _password, value);
            UpdateSignInButtonState();
        }
    }
    private void UpdateSignInButtonState()
    {
        IsEnabledNavigateToSignIn = !string.IsNullOrWhiteSpace(Login)
                                && !string.IsNullOrWhiteSpace(Password);
    }
    private async void OnLoginAsync(object? obj)
    {
        if (string.IsNullOrWhiteSpace(Login) ||
            string.IsNullOrWhiteSpace(Password))
        {
            MessageBox.Show("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è.");
            return;
        }

        HumansModel user = new UsersModel(Login, Password);
        HumansModel admin = new AdminsModel(Login, Password);

        try
        {
            if (await _userService.OnLoginAsync(user))
            {
                _navigateService.NavigateTo<UserPageViewModel>();
            }
            else if(await _userService.OnLoginAsync(admin))
            {
                _navigateService.NavigateTo<AdminPageViewModel>();
            }
            else
            {
                MessageBox.Show("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏.");
            }
        }
        catch (Exception ex)
        {
            MessageBox.Show("–û—à–∏–±–∫–∞: " + ex.Message);
        }
    }
    
    private bool _isEnabledNavigateToSignIn = false;
    public bool IsEnabledNavigateToSignIn
    {
        get => _isEnabledNavigateToSignIn;
        set
        {
            _isEnabledNavigateToSignIn = value;
            OnPropertyChanged();
        }
    }
}

using DataLayer.Services;
using Model;
using System.Windows;
using System.Windows.Input;
using ViewModel.Core;
using ViewModel.Services.Interfaces;

namespace ViewModel.PagesViewModel;
public class RegistrationPageViewModel : BasePageViewModel
{
    public RegistrationPageViewModel() { } // –ù—É–∂–µ–Ω –¥–ª—è –¥–∏–∑–∞–π–Ω–µ—Ä–∞
    private readonly INavigateService _navigateService;
    private readonly Service _userService;
    public ICommand BackToLoginPage { get; }
    public ICommand SendFormRegistration { get; }

    private string _login;
    private string _password;
    private string _name;
    private string _surname;
    private string _patronymic;
    private string _mail;
    private string _phoneNumber;
    public RegistrationPageViewModel(INavigateService navigateService, Service userService)
    {
        _navigateService = navigateService;
        _userService = userService;

        BackToLoginPage = new RelayCommand(obj => navigateService.NavigateTo<LoginPageViewModel>());
        SendFormRegistration = new RelayCommand(OnSendForm);
    }
    private async void OnSendForm(object? obj)
    {
        if (string.IsNullOrWhiteSpace(Login) ||
            string.IsNullOrWhiteSpace(Password) ||
            string.IsNullOrWhiteSpace(Name) ||
            string.IsNullOrWhiteSpace(Surname) ||
            string.IsNullOrWhiteSpace(Mail))
        {
            MessageBox.Show("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è.");
            return;
        }

        var user = new UsersModel
        (
            Login,
            Password,
            Name,
            Surname,
            Patronymic,
            Mail,
            PhoneNumber
        );

        try
        {
            int newId = await _userService.AddHumanAsync(user);

            if (newId > 0)
            {
                MessageBox.Show($"–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞! ID: {newId}");
                _navigateService.NavigateTo<LoginPageViewModel>();
            }
            else
            {
                MessageBox.Show("–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.");
            }
        }
        catch (Exception ex)
        {
            MessageBox.Show("–û—à–∏–±–∫–∞: " + ex.Message);
        }
    }

    public string Login
    {
        get => _login;
        set
        {
            Set(ref _login, value);
            UpdateSendButtonState();
        } 
    }
    public string Password
    {
        get => _password;
        set
        {
            Set(ref _password, value);
            UpdateSendButtonState();
        }
    }
    public string Name
    {
        get => _name;
        set
        {
            Set(ref _name, value);
            UpdateSendButtonState();
        }
    }
    public string Surname
    {
        get => _surname;
        set
        {
            Set(ref _surname, value);
            UpdateSendButtonState();
        }
    }
    public string Patronymic
    {
        get => _patronymic;
        set
        {
            Set(ref _patronymic, value);
            UpdateSendButtonState();
        }
    }
    public string Mail
    {
        get => _mail;
        set
        {
            Set(ref _mail, value);
            UpdateSendButtonState();
        }
    }
    public string PhoneNumber
    {
        get => _phoneNumber;
        set
        {
            Set(ref _phoneNumber, value);
            UpdateSendButtonState();
        }
    }
    private void UpdateSendButtonState()
    {
        IsEnabledSendFormRegistration = !string.IsNullOrWhiteSpace(Login)
                                    && !string.IsNullOrWhiteSpace(Password)
                                    && !string.IsNullOrWhiteSpace(Name)
                                    && !string.IsNullOrWhiteSpace(Surname)
                                    && !string.IsNullOrWhiteSpace(Patronymic)
                                    && !string.IsNullOrWhiteSpace(Mail)
                                    && !string.IsNullOrWhiteSpace(PhoneNumber);
           
    }
    private bool _isEnabledSendFormRegistration = false;
    public bool IsEnabledSendFormRegistration 
    { 
        get => _isEnabledSendFormRegistration;
        set
        {
            _isEnabledSendFormRegistration = value;
            OnPropertyChanged();
        } 
    }
}

using DataLayer.Services;
using System.Data;
using System.IO;
using System.Windows;
using System.Windows.Input;
using System.Windows.Media.Imaging;
using ViewModel.Core;
using ViewModel.Services.Interfaces;

namespace ViewModel.PagesViewModel;
public class UserPageViewModel : BasePageViewModel
{
    public UserPageViewModel() { } // –ù—É–∂–µ–Ω –¥–ª—è –¥–∏–∑–∞–π–Ω–µ—Ä–∞
    private readonly INavigateService _navigateService;
    private readonly Service _service;
    private readonly DataLayer.Models.DataBaseContext _dbContext;
    public string? LoginUser => _service.CurrentHuman?.Login;
    public string? NameUser => _service.CurrentHuman?.Name;
    public string? SurnameUser => _service.CurrentHuman?.Surname;
    public string? EmailUser => _service.CurrentHuman?.Mail;
    public string? PhoneUser => _service.CurrentHuman?.PhoneNumber;
    public ICommand LogOut { get; }
    public ICommand ShowTop3Products { get; }
    public ICommand SearchProductByName { get; }
    public ICommand SearchProductByPrice { get; }
    public ICommand ShowProductInCategory { get; }
    public ICommand ShowProductInPortions { get; }
    public ICommand SearchOrdersByDate { get; }
    public ICommand ShowUserOrderHistory { get; }
    public ICommand CreateOrder { get; }
    public ICommand ShowAllProducts { get; }

    private int _skipRows = 0;
    private int _countPortions;
    public int CountPortions 
    { 
        get => _countPortions;
        set
        {
            Set(ref _countPortions, value);
            UpdateCountPortionsButtonState();
        }
    }
    public ICommand EnterCountPortions { get; }
    public ICommand LeftArrowCountPortions { get; }
    public ICommand RightArrowCountPortions { get; }

    private DataTable _data;
    public DataTable Data
    {
        get => _data;
        set
        {
            _data = value;
            OnPropertyChanged();
        }
    }
    public UserPageViewModel(INavigateService navigateService, Service service, DataLayer.Models.DataBaseContext dbContext)
    {
        _navigateService = navigateService;
        _service = service;
        _dbContext = dbContext;

        LogOut = new RelayCommand(obj =>
        {
            IsPortionsFormVisible = Visibility.Collapsed;
            service.LogOut();
            navigateService.NavigateTo<LoginPageViewModel>();
        });
        ShowTop3Products = new AsyncRelayCommand(async () =>
        {
            try
            {
                IsPortionsFormVisible = Visibility.Collapsed;
                var result = await _service.GetTop3ProductsAsync();
                Data = await AddImageColumnAsync(result);
            }
            catch (Exception ex)
            {
                MessageBox.Show("–û—à–∏–±–∫–∞: " + ex.Message);
            }
        });
        SearchProductByName = new RelayCommand(async obj => 
        {
            IsPortionsFormVisible = Visibility.Collapsed;
        });
        SearchProductByPrice = new RelayCommand(async obj => 
        {
            IsPortionsFormVisible = Visibility.Collapsed;
        });
        ShowProductInCategory = new RelayCommand(async obj => 
        {
            IsPortionsFormVisible = Visibility.Collapsed;
        });
        ShowProductInPortions = new RelayCommand(async obj => 
        {
            try
            {
                IsPortionsFormVisible = Visibility.Visible;
            }
            catch (Exception ex)
            {
                MessageBox.Show("–û—à–∏–±–∫–∞: " + ex.Message);
            }
        });
        EnterCountPortions = new AsyncRelayCommand(async () =>
        {
            try
            {
                var result = await _service.GetShowProductsInPortionsAsync(_skipRows, CountPortions);
                Data = await AddImageColumnAsync(result);
            }
            catch (Exception ex)
            {
                MessageBox.Show("–û—à–∏–±–∫–∞: " + ex.Message);
            }
        });
        LeftArrowCountPortions = new AsyncRelayCommand(async () =>
        {
            try
            {
                if (_skipRows > 0)
                {
                    _skipRows -= CountPortions;
                    if (_skipRows < 0) _skipRows = 0;
                }
                var result = await _service.GetShowProductsInPortionsAsync(_skipRows, CountPortions);
                Data = await AddImageColumnAsync(result);
            }
            catch (Exception ex)
            {
                MessageBox.Show("–û—à–∏–±–∫–∞: " + ex.Message);
            }
        });
        RightArrowCountPortions = new AsyncRelayCommand(async () =>
        {
            try
            {
                var products = await _service.GetListAllProductsAsync();
                var totalCount = products.Count;
                var maxSkipRows = (totalCount / CountPortions) * CountPortions;
                if (_skipRows + CountPortions < totalCount)
                {
                    _skipRows += CountPortions;
                    var result = await _service.GetShowProductsInPortionsAsync(_skipRows, CountPortions);
                    Data = await AddImageColumnAsync(result);
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show("–û—à–∏–±–∫–∞: " + ex.Message);
            }
        });
        SearchOrdersByDate = new RelayCommand(async obj => 
        {
            IsPortionsFormVisible = Visibility.Collapsed;
        });
        ShowUserOrderHistory = new AsyncRelayCommand(async () =>
        {
            try
            {
                IsPortionsFormVisible = Visibility.Collapsed;
                var result = await _service.GetUserOrderHistoryAsync();
                Data = await AddImageColumnAsync(result);
            }
            catch (Exception ex)
            {
                MessageBox.Show("–û—à–∏–±–∫–∞: " + ex.Message);
            }
        });
        CreateOrder = new RelayCommand(async obj => 
        {
            IsPortionsFormVisible = Visibility.Collapsed;
        });
        ShowAllProducts = new RelayCommand(async obj => 
        {
            IsPortionsFormVisible = Visibility.Collapsed;
        });
    }

    private Visibility _isPortionsFormVisible = Visibility.Collapsed;
    public Visibility IsPortionsFormVisible
    {
        get => _isPortionsFormVisible;
        set
        {
            _isPortionsFormVisible = value;
            OnPropertyChanged();
        }
    }

    private bool _enterCountPortionsIsEnabled = false;
    public bool EnterCountPortionsIsEnabled
    {
        get => _enterCountPortionsIsEnabled;
        set
        {
            _enterCountPortionsIsEnabled = value;
            OnPropertyChanged();
        }
    }
    private void UpdateCountPortionsButtonState()
    {
        EnterCountPortionsIsEnabled = CountPortions > 0;
    }

    private byte[] _imageData;
    public byte[] ImageData
    {
        get => _imageData;
        set
        {
            if (Set(ref _imageData, value))
            {
                OnPropertyChanged(nameof(Image));
            }
        }
    }
    public BitmapImage Image
    {
        get
        {
            if (_imageData == null || _imageData.Length == 0)
                return null;

            try
            {
                var image = new BitmapImage();
                using (var stream = new MemoryStream(_imageData))
                {
                    image.BeginInit();
                    image.StreamSource = stream;
                    image.CacheOption = BitmapCacheOption.OnLoad;
                    image.EndInit();
                    image.Freeze();
                }
                return image;
            }
            catch
            {
                return null;
            }
        }
    }
    private async Task<DataTable> AddImageColumnAsync(DataTable table)
    {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –≤ —Ç–∞–±–ª–∏—Ü–µ —Å—Ç–æ–ª–±–µ—Ü "images_id"
        if (!table.Columns.Contains("images_id"))
        {
            // –ï—Å–ª–∏ —Å—Ç–æ–ª–±—Ü–∞ –Ω–µ—Ç ‚Äî –ø—Ä–æ—Å—Ç–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∏—Å—Ö–æ–¥–Ω—É—é —Ç–∞–±–ª–∏—Ü—É. –ù–ò–ß–ï–ì–û –ù–ï –õ–û–ú–ê–ï–ú.
            return table;
        }

        try
        {
            // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π —Å—Ç–æ–ª–±–µ—Ü –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
            table.Columns.Add("Image", typeof(byte[]));

            // –ü—Ä–æ—Ö–æ–¥–∏–º –ø–æ –∫–∞–∂–¥–æ–π —Å—Ç—Ä–æ–∫–µ –∏ –∑–∞–ø–æ–ª–Ω—è–µ–º —Å—Ç–æ–ª–±–µ—Ü "Image"
            foreach (DataRow row in table.Rows)
            {
                if (row["images_id"] != DBNull.Value && int.TryParse(row["images_id"].ToString(), out int imageId))
                {
                    var imageEntity = await _dbContext.imagesSets.FindAsync(imageId);
                    row["Image"] = imageEntity?.image; // –ü—Ä–∏—Å–≤–∞–∏–≤–∞–µ–º –º–∞—Å—Å–∏–≤ –±–∞–π—Ç –∏–ª–∏ null
                }
                else
                {
                    // –ï—Å–ª–∏ images_id null –∏–ª–∏ –Ω–µ —á–∏—Å–ª–æ ‚Äî –æ—Å—Ç–∞–≤–ª—è–µ–º Image –∫–∞–∫ null
                    row["Image"] = DBNull.Value;
                }
            }

            // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π —Å—Ç–æ–ª–±–µ—Ü "images_id", —á—Ç–æ–±—ã –æ–Ω –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞–ª—Å—è
            table.Columns.Remove("images_id");
        }
        catch (Exception ex)
        {
            // –õ–æ–≥–∏—Ä—É–µ–º –æ—à–∏–±–∫—É, –Ω–æ –ù–ï –ü–†–û–ü–£–°–ö–ê–ï–ú –∏—Å–∫–ª—é—á–µ–Ω–∏–µ!
            Console.WriteLine($"‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —Å—Ç–æ–ª–±—Ü–∞ Image: {ex.Message}");
            // –ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∏—Å—Ö–æ–¥–Ω—É—é —Ç–∞–±–ª–∏—Ü—É –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
            return table;
        }

        return table;
    }
}

using Microsoft.Extensions.DependencyInjection;
using System.Windows.Controls;
using ViewModel.Core;
using ViewModel.ModalWindowsViewModel;
using ViewModel.PagesViewModel;
using ViewModel.Services.Interfaces;

namespace ViewModel.Services.Classes;

public class NavigateService : INavigateService
{
    private readonly IServiceProvider _provider;
    private Frame _frame;

    public NavigateService(IServiceProvider provider)
    {
        _provider = provider;
    }

    public event Action<string>? Navigated;

    public void ConfigureNavigation(Frame mainFrame)
    {
        _frame = mainFrame;
    }

    public void NavigateTo<T>() where T : BasePageViewModel
    {
        var viewModel = _provider.GetRequiredService<T>();

        string pageName = viewModel switch
        {
            LoginPageViewModel => "LoginPageView",
            RegistrationPageViewModel => "RegistrationPageView",
            AdminPageViewModel => "AdminPageView",
            UserPageViewModel => "UserPageView",
            RegistrationWindowViewModel => "RegistrationWindowViewModel",
            _ => throw new ArgumentException($"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è ViewModel: {typeof(T).Name}")
        };

        Navigated?.Invoke(pageName);
    }
}

namespace ViewModel.Services.Interfaces
{
    public interface IClosable
    {
        event Action? RequestClose;
    }
}

public interface IDialogService
{
    void ShowModal(object viewModel);
}

using System.Windows.Controls;
using ViewModel.Core;

namespace ViewModel.Services.Interfaces;

public interface INavigateService
{
    void NavigateTo<T>() where T : BasePageViewModel;
    void ConfigureNavigation(Frame mainFrame);
    event Action<string> Navigated;
}

version: '3.4'

services:
  server:
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:8080;https://+:8081
    ports:
      - "8080:8080"
      - "8081:8081"

version: '3.4'

services:
  server:
    image: server
    build:
      context: .
      dockerfile: Server/Dockerfile

using DataLayer.Services;
using Microsoft.AspNetCore.Mvc;
using Model;
using Server.Dtos;

namespace Server.Controllers
{
    // –≠—Ç–æ –±–∞–∑–æ–≤—ã–π –∞—Ç—Ä–∏–±—É—Ç –¥–ª—è –≤—Å–µ—Ö –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–æ–≤ Web API
    [ApiController]
    // –≠—Ç–æ –ø—É—Ç—å: "api/auth" ‚Äî –ø–æ —ç—Ç–æ–º—É –∞–¥—Ä–µ—Å—É –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä
    [Route("api/[controller]")]
    public class authController : ControllerBase
    {
        private readonly Service _service;

        // –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä ‚Äî —Å—é–¥–∞ ASP.NET –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–¥–∞—Å—Ç —Ç–≤–æ–π Service
        public authController(Service service)
        {
            _service = service;
        }

        // –≠—Ç–æ –º–µ—Ç–æ–¥ API –¥–ª—è –≤—Ö–æ–¥–∞
        // –ö–æ–≥–¥–∞ –∫–ª–∏–µ–Ω—Ç –≤—ã–∑–æ–≤–µ—Ç POST –∑–∞–ø—Ä–æ—Å –Ω–∞ "api/auth/login" ‚Äî —Å—Ä–∞–±–æ—Ç–∞–µ—Ç —ç—Ç–æ—Ç –º–µ—Ç–æ–¥
        [HttpPost("login")]
        public async Task<IActionResult> Login([FromBody] LoginRequest request)
        {
            if (string.IsNullOrWhiteSpace(request.Login) || string.IsNullOrWhiteSpace(request.Password))
            {
                return BadRequest(new { error = "–õ–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã" });
            }
            try
            {
                // 1. –°–æ–∑–¥–∞—ë–º –º–æ–¥–µ–ª–∏ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
                var user = new UsersModel(request.Login, request.Password);
                var admin = new AdminsModel(request.Login, request.Password);

                // 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
                if (await _service.OnLoginAsync(user))
                {
                    if (_service.CurrentHuman == null)
                        return Unauthorized(new { error = "–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏" });

                    // 3. –§–æ—Ä–º–∏—Ä—É–µ–º –ë–ï–ó–û–ü–ê–°–ù–´–ô –æ—Ç–≤–µ—Ç –±–µ–∑ –ø–∞—Ä–æ–ª—è
                    var response = new LoginResponse
                    {
                        Id = _service.CurrentHuman.Id,
                        Login = _service.CurrentHuman.Login,
                        Name = _service.CurrentHuman.Name,
                        Surname = _service.CurrentHuman.Surname,
                        Type = "user"
                    };
                    return Ok(response);
                }
                else if (await _service.OnLoginAsync(admin))
                {
                    if (_service.CurrentHuman == null)
                        return Unauthorized(new { error = "–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏" });

                    var response = new LoginResponse
                    {
                        Id = _service.CurrentHuman.Id,
                        Login = _service.CurrentHuman.Login,
                        Name = _service.CurrentHuman.Name,
                        Surname = _service.CurrentHuman.Surname,
                        Type = "admin"
                    };
                    return Ok(response);
                }

                return Unauthorized(new { error = "–ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å" });
            }
            catch (Exception ex)
            {
                return StatusCode(500, new { error = ex.Message });
            }
        }

        // POST api/auth/logout
        [HttpPost("logout")]
        public IActionResult Logout()
        {
            _service.LogOut();
            return Ok(new { message = "–í—ã—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω" });
        }
    }

    // –ú–æ–¥–µ–ª—å –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞ –≤—Ö–æ–¥–∞
    public class LoginRequest
    {
        public string Login { get; set; } = string.Empty;
        public string Password { get; set; } = string.Empty;
    }
}

using Microsoft.AspNetCore.Mvc;
using DataLayer.Services;

namespace Server.Controllers
{
    [ApiController]
    [Route("api/[controller]")]
    public class productsController : ControllerBase
    {
        private readonly Service _service;

        public productsController(Service service)
        {
            _service = service;
        }

        // GET api/products/top3
        [HttpGet("top3")]
        public async Task<IActionResult> GetTop3Products()
        {
            try
            {
                var result = await _service.GetTop3ProductsAsync();
                return Ok(result);
            }
            catch (Exception ex)
            {
                return StatusCode(500, new { error = ex.Message });
            }
        }

        // GET api/products/portion
        [HttpGet("portion")]
        public async Task<IActionResult> GetProductsInPortions(
            [FromQuery] int skipRows = 0,
            [FromQuery] int showRows = 10)
        { 
            try
            {
                var result = await _service.GetShowProductsInPortionsAsync(skipRows, showRows);
                return Ok(result);
            }
            catch (Exception ex)
            {
                return StatusCode(500, new { error = ex.Message });
            }
        }
    }
}

namespace Server.Dtos
{
    public class LoginRequest
    {
        public string Login { get; set; } = string.Empty;
        public string Password { get; set; } = string.Empty;
    }
}

namespace Server.Dtos
{
    public class LoginResponse
    {
        public int Id { get; set; }
        public string Login { get; set; } = string.Empty;
        public string Name { get; set; } = string.Empty;
        public string Surname { get; set; } = string.Empty;
        public string Type { get; set; } = "user"; // "user" –∏–ª–∏ "admin"
    }
}

namespace Server.DTOs
{
    public class RegisterRequest
    {
    }
}


namespace Server.Dtos
{
    public class UserDto
    {
        public int Id { get; set; }
        public string Login { get; set; } = string.Empty;
        public string Name { get; set; } = string.Empty;
        public string Surname { get; set; } = string.Empty;
        public string Patronymic { get; set; } = string.Empty;
        public string Mail { get; set; } = string.Empty;
        public string PhoneNumber { get; set; } = string.Empty;
        public DateTime? RegistrationDate { get; set; }
    }
}

# –°–º. —Å—Ç–∞—Ç—å—é –ø–æ —Å—Å—ã–ª–∫–µ https://aka.ms/customizecontainer, —á—Ç–æ–±—ã —É–∑–Ω–∞—Ç—å –∫–∞–∫ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –æ—Ç–ª–∞–¥–∫–∏ –∏ –∫–∞–∫ Visual Studio –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —ç—Ç–æ—Ç Dockerfile –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –æ–±—Ä–∞–∑–æ–≤ –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è –æ—Ç–ª–∞–¥–∫–∏.

# –≠—Ç–æ—Ç —ç—Ç–∞–ø –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –∏–∑ VS –≤ –±—ã—Å—Ç—Ä–æ–º —Ä–µ–∂–∏–º–µ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –æ—Ç–ª–∞–¥–∫–∏)
FROM mcr.microsoft.com/dotnet/aspnet:9.0 AS base
USER $APP_UID
WORKDIR /app
EXPOSE 8080
EXPOSE 8081


# –≠—Ç–æ—Ç —ç—Ç–∞–ø –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Å–±–æ—Ä–∫–∏ –ø—Ä–æ–µ–∫—Ç–∞ —Å–ª—É–∂–±—ã
FROM mcr.microsoft.com/dotnet/sdk:9.0 AS build
ARG BUILD_CONFIGURATION=Release
WORKDIR /src
COPY ["Examen/Server/Server.csproj", "Examen/Server/"]
RUN dotnet restore "./Examen/Server/Server.csproj"
COPY . .
WORKDIR "/src/Examen/Server"
RUN dotnet build "./Server.csproj" -c $BUILD_CONFIGURATION -o /app/build

# –≠—Ç–æ—Ç —ç—Ç–∞–ø –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞ —Å–ª—É–∂–±—ã, –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –Ω–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π —ç—Ç–∞–ø
FROM build AS publish
ARG BUILD_CONFIGURATION=Release
RUN dotnet publish "./Server.csproj" -c $BUILD_CONFIGURATION -o /app/publish /p:UseAppHost=false

# –≠—Ç–æ—Ç —ç—Ç–∞–ø –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ —Ä–∞–±–æ—á–µ–π —Å—Ä–µ–¥–µ –∏–ª–∏ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –∏–∑ VS –≤ –æ–±—ã—á–Ω–æ–º —Ä–µ–∂–∏–º–µ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é, –∫–æ–≥–¥–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –æ—Ç–ª–∞–¥–∫–∏ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è)
FROM base AS final
WORKDIR /app
COPY --from=publish /app/publish .
ENTRYPOINT ["dotnet", "Server.dll"]

using DataLayer.Services;
using Microsoft.EntityFrameworkCore;

var builder = WebApplication.CreateBuilder(args);

// –î–æ–±–∞–≤–ª—è–µ–º —Å–µ—Ä–≤–∏—Å—ã –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä DI (–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è DbContext)
builder.Services.AddDbContext<DataLayer.Models.DataBaseContext>(options =>
    options.UseSqlServer(builder.Configuration.GetConnectionString("ModelsConnection")));

builder.Services.AddDbContext<DataLayer.Procedures.DataBaseContext>(options =>
    options.UseSqlServer(builder.Configuration.GetConnectionString("ProceduresConnection")));

builder.Services.AddDbContext<DataLayer.Views.DataBaseContext>(options =>
    options.UseSqlServer(builder.Configuration.GetConnectionString("ViewsConnection")));

// –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º —Å–µ—Ä–≤–∏—Å
builder.Services.AddScoped<Service>();

// –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä—ã (API)
builder.Services.AddControllers();

// –î–æ–±–∞–≤–ª—è–µ–º Swagger
builder.Services.AddSwaggerGen(c =>
{
    c.SwaggerDoc("v1", new Microsoft.OpenApi.Models.OpenApiInfo
    {
        Title = "Examen API",
        Version = "v1"
    });
});

// CORS - —á—Ç–æ–±—ã WPF –∫–ª–∏–µ–Ω—Ç –º–æ–≥ –æ–±—Ä–∞—â–∞—Ç—å—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É
builder.Services.AddCors(options =>
{
    options.AddPolicy("AllowAll", policy =>
    {
        policy.AllowAnyOrigin()  // –†–∞–∑—Ä–µ—à–∞–µ—Ç –∑–∞–ø—Ä–æ—Å—ã —Å –ª—é–±–æ–≥–æ –¥–æ–º–µ–Ω–∞ (–¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏)
              .AllowAnyMethod()  // –†–∞–∑—Ä–µ—à–∞–µ—Ç –ª—é–±—ã–µ –º–µ—Ç–æ–¥—ã (GET, POST, PUT –∏ —Ç.–¥.)
              .AllowAnyHeader(); // –†–∞–∑—Ä–µ—à–∞–µ—Ç –ª—é–±—ã–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏
    });
});

var app = builder.Build();

app.UseSwagger();
app.UseSwaggerUI(c =>
{
    c.SwaggerEndpoint("/swagger/v1/swagger.json", "Examen API V1");
});

app.UseHttpsRedirection();
app.UseCors("AllowAll");
app.MapControllers();

app.Run();

